<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Mengatur font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styling untuk Navigasi Bawah */
        .nav-bar {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .active-nav-item {
            color: #1d4ed8; /* Blue-700 */
            border-top: 2px solid #1d4ed8;
        }
        /* Style untuk Carousel */
        .carousel-item {
            width: 100%;
            flex-shrink: 0;
        }
        /* Memastikan track carousel bisa di-drag */
        #carousel-track {
            touch-action: pan-y; /* Hanya geser vertikal secara default */
            cursor: grab;
        }
        #carousel-track:active {
             cursor: grabbing;
        }
        /* Style ringan untuk modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar untuk performa */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        /* Animasi loading ringan */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex items-center justify-center hidden">
        <div class="spinner"></div>
        <p class="ml-3 text-lg font-medium text-gray-700">Memuat data...</p>
    </div>

    <!-- Main Content Container -->
    <div id="app-content" class="flex-grow pb-[60px] overflow-x-hidden">
        <!-- Konten halaman akan dirender di sini -->
    </div>

    <!-- Sticky Bottom Navigation Bar (Fixed for mobile and desktop) -->
    <nav id="nav-bar" class="nav-bar fixed bottom-0 left-0 right-0 h-14 bg-white z-50 flex justify-around items-center border-t border-gray-200">
        <!-- Nav items will be generated by JS -->
    </nav>

    <!-- Modal Container (Hidden by default) -->
    <div id="modal-container" class="modal fixed inset-0 z-[1000] bg-black bg-opacity-70 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <!-- Modal content will be injected here -->
    </div>

    <!-- Session Timeout Modal -->
    <div id="session-modal" class="modal fixed inset-0 z-[1001] bg-black bg-opacity-80 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-3">Sesi Berakhir</h3>
            <p class="text-gray-700 mb-6">Waktu melihat Anda telah habis (30 menit). Silakan muat ulang halaman untuk melanjutkan.</p>
            <button onclick="window.location.reload();" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">Muat Ulang Halaman</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // PASTIKAN ANDA SUDAH MENGGANTI INI DENGAN URL WEB APP ANDA YANG SUDAH DIDEPLOY
        const API_URL = "https://script.google.com/macros/s/AKfycby3uWVoeBtbcY1oAjbkCNdRFT8ew7_VEtwe-WG8ka1OJqNUDj0GX4zdAwcI_nsexYNhFA/exec"; 
        const SESSION_DURATION_MS = 30 * 60 * 1000; // 30 menit
        const MAX_CONTENT_LENGTH = 200; // Untuk ringkasan berita

        // --- GLOBAL STATE ---
        let appData = {};
        let currentPage = 'Home';
        let sessionTimeout;
        let isDataLoaded = false;

        // --- CAROUSEL DRAG/TOUCH STATE ---
        let isDragging = false;
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let animationID;
        let currentCarouselIndex = 0;
        let carouselInterval;
        let modalCarouselIndex = 0;
        let totalCarouselItems = 0;
        let carouselTrack;

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Mengubah data tanggal (Date object atau string YYYY-MM-DD) ke format Indonesia.
         * Format: Hari, DD Bulan YYYY (contoh: Senin, 10 November 2025)
         * @param {Date|string} dateInput Tanggal.
         */
        const formatDate = (dateInput) => {
            if (!dateInput) return '-';

            let date;
            if (dateInput instanceof Date) {
                date = dateInput;
            } else {
                // Menerima format YYYY-MM-DD (dari spreadsheet)
                const parts = dateInput.split('-');
                if (parts.length === 3) {
                    // Gunakan new Date(tahun, bulan-1, hari) untuk menghindari masalah zona waktu
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    date = new Date(dateInput);
                }
            }

            if (isNaN(date.getTime())) return '-';
            
            const options = {
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            // Format penuh Indonesia: Hari, DD Bulan YYYY
            return date.toLocaleDateString('id-ID', options);
        };

        /**
         * Mengubah teks menjadi slug sederhana untuk URL.
         * @param {string} text 
         */
        const slugify = (text) => {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        };

        /**
         * Memotong teks hingga jumlah kata tertentu, menambahkan elipsis.
         * @param {string} text 
         * @param {number} maxWords 
         */
        const truncateText = (text, maxWords) => {
            const words = text.split(/\s+/);
            if (words.length > maxWords) {
                return words.slice(0, maxWords).join(' ') + '...';
            }
            return text;
        };

        /**
         * Mengambil data dari Apps Script API dengan penanganan loading.
         * @param {string} route Rute API (cth: 'getInitialData').
         * @param {Object} params Parameter query.
         */
        const fetchData = async (route, params = {}) => {
            const loadingElement = document.getElementById('loading');
            
            // Tampilkan loading, tapi hanya setelah 100ms untuk menghindari kedipan pada respons cepat
            const loadingTimeout = setTimeout(() => {
                loadingElement.classList.remove('hidden');
            }, 100);

            try {
                // Pengecekan API_URL sebelum fetch
                if (API_URL.includes("GANTI DENGAN URL WEB APP")) {
                    throw new Error("API_URL belum diganti dengan URL Web App Apps Script yang valid.");
                }

                const url = new URL(API_URL);
                url.searchParams.set('route', route);
                for (const key in params) {
                    url.searchParams.set(key, params[key]);
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    return data.data;
                } else {
                    console.error('API Error:', data.message);
                    throw new Error(`Gagal dari server: ${data.message}`);
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                // Tampilkan pesan error di UI jika gagal
                document.getElementById('app-content').innerHTML = `
                    <div class="p-8 text-center text-red-600 bg-red-100 m-4 rounded-lg">
                        <p class="font-bold mb-2">Gagal Memuat Data Awal!</p>
                        <p>Pastikan Anda telah mengganti API_URL di index.html dengan URL Web App Apps Script yang benar.</p>
                        <p class="text-sm mt-2">Detail Error: ${error.message}</p>
                    </div>
                `;
                return null;
            } finally {
                clearTimeout(loadingTimeout);
                loadingElement.classList.add('hidden');
            }
        };

        // --- SESSION MANAGEMENT ---

        const startSessionTimer = () => {
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            sessionTimeout = setTimeout(() => {
                const sessionModal = document.getElementById('session-modal');
                sessionModal.classList.remove('opacity-0', 'pointer-events-none');
            }, SESSION_DURATION_MS);

            console.log(`Sesi dimulai, akan berakhir dalam ${SESSION_DURATION_MS / 60000} menit.`);
        };

        // --- RENDERING COMPONENTS ---

        const renderHeader = (title = 'DASHBOARD') => {
            const headerData = appData.kepala_halaman || {};
            const logoPSSI = headerData.logo_pssi || 'https://placehold.co/50x50/cccccc/333333?text=PSSI';
            const judulKepala = headerData.judul_kepala || title;
            const logoASKAB = headerData.logo_askab || 'https://placehold.co/50x50/333333/ffffff?text=ASKAB';

            return `
                <header class="sticky top-0 bg-white p-3 border-b border-gray-200 shadow-md z-40">
                    <div class="container mx-auto flex items-center justify-between">
                        <img src="${logoPSSI}" alt="Logo PSSI" class="h-10 w-10 object-contain rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=PSSI'" loading="lazy">
                        <h1 class="text-base sm:text-lg font-bold text-center text-gray-800 flex-grow mx-2">${judulKepala}</h1>
                        <img src="${logoASKAB}" alt="Logo ASKAB" class="h-10 w-10 object-contain rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/50x50/333333/ffffff?text=ASKAB'" loading="lazy">
                    </div>
                </header>
            `;
        };

        const renderNavBar = () => {
            const navBar = document.getElementById('nav-bar');
            navBar.innerHTML = '';

            const navItems = [
                { name: 'Home', icon: 'Home' },
                { name: 'Kompetisi', icon: 'Trophy' },
                { name: 'Klub', icon: 'Shield' },
                { name: 'Tentang', icon: 'Info' }
            ];

            navItems.forEach(item => {
                const isActive = currentPage === item.name;
                const button = document.createElement('button');
                button.className = `flex flex-col items-center justify-center p-2 text-sm font-medium transition-colors duration-200 ${isActive ? 'text-blue-600 active-nav-item border-t-2 border-blue-600' : 'text-gray-500 hover:text-blue-600 hover:bg-gray-50'}`;
                button.setAttribute('data-page', item.name);
                button.innerHTML = `
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">${item.name}</span>
                `;
                button.onclick = () => navigate(item.name);
                navBar.appendChild(button);
                
                lucide.createIcons();
            });
        };

        const renderHome = () => {
            const newsData = appData.berita_home || [];
            const bannerData = appData.banner || [];
            
            // Tambahkan logging untuk memeriksa data berita
            console.log("Data Berita yang dimuat:", newsData.length, "item.");
            if (newsData.length > 0) {
                 console.log("Contoh Berita Pertama:", newsData[0]);
            }
            
            const sortedNews = newsData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let content = renderHeader('ASKAB PSSI KEPULAUAN MENTAWAI');
            content += `
                <div class="p-4 space-y-6">
                    <!-- Kolom Pencarian Berita -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="news-search" placeholder="Cari Berita (Judul/Isi)" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Home', this.value)">
                        </div>
                    </div>

                    <!-- Banner Slide (Carousel) -->
                    <h2 class="text-xl font-bold text-gray-800">Galeri Terbaru (Swipe/Drag)</h2>
                    <div class="relative overflow-hidden rounded-xl shadow-lg h-48 sm:h-64 bg-gray-200" id="banner-carousel">
                        <div class="flex h-full w-full" id="carousel-track" 
                            ontouchstart="startDrag(event)" 
                            ontouchmove="onDrag(event)" 
                            ontouchend="endDrag(event)"
                            onmousedown="startDrag(event)" 
                            onmousemove="onDrag(event)" 
                            onmouseup="endDrag(event)"
                            onmouseleave="endDrag(event)">
                            ${bannerData.map((item, index) => {
                                // Ambil gambar pertama yang valid dari 3 kolom
                                const imageUrl = item['poto-1'] || item['poto-2'] || item['poto-3'] || 'https://placehold.co/800x400/3b82f6/ffffff?text=BANNER';
                                return `
                                    <div class="carousel-item h-full">
                                        <img src="${imageUrl}" alt="Banner ${index + 1}" class="w-full h-full object-cover" 
                                            onerror="this.onerror=null;this.src='https://placehold.co/800x400/3b82f6/ffffff?text=BANNER'" loading="lazy">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Ringkasan Berita (Tampilan Berita) -->
                    <h2 class="text-xl font-bold text-gray-800">Berita Terbaru</h2>
                    <div id="news-list" class="space-y-4">
                        ${sortedNews.map(item => renderNewsCard(item)).join('')}
                        ${sortedNews.length === 0 ? '<p class="text-center text-gray-500">Belum ada berita yang tersedia.</p>' : ''}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
            initCarousel(bannerData.length);
        };

        const renderNewsCard = (item) => {
            // Pastikan item memiliki Judul_Berita dan isi_berita agar kartu muncul
            if (!item.Judul_Berita || !item.isi_berita) {
                console.warn("Melewati Berita karena data Judul_Berita atau isi_berita kosong/null.", item);
                return ''; // Jika data berita kosong, jangan render kartu
            }
            
            const firstImage = item.gambar_1 || item.gambar_2 || item.gambar_3 || 'https://placehold.co/400x250/9ca3af/ffffff?text=NO+IMAGE';
            const summary = truncateText(item.isi_berita || '', 20); // 20 kata pertama
            const date = formatDate(item.tanggal);

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transition transform hover:scale-[1.01] cursor-pointer" onclick="showNewsModal('${item.id_berita}')">
                    <div class="flex flex-col sm:flex-row">
                        <!-- Gambar Berita -->
                        <div class="w-full sm:w-1/3 h-40 sm:h-auto overflow-hidden">
                            <img src="${firstImage}" alt="${item.Judul_Berita}" class="w-full h-full object-cover transition duration-300 hover:opacity-90" 
                                onerror="this.onerror=null;this.src='https://placehold.co/400x250/9ca3af/ffffff?text=NO+IMAGE'" loading="lazy">
                        </div>
                        
                        <!-- Konten Berita -->
                        <div class="w-full sm:w-2/3 p-4">
                            <p class="text-sm font-semibold text-blue-600 mb-1">${date}</p>
                            <h3 class="text-lg font-bold text-gray-800 mb-2 line-clamp-2">${item.Judul_Berita}</h3>
                            <p class="text-gray-600 text-sm">${summary}</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- Modal & Share Functions ---
        
        const showNewsModal = async (id_berita) => {
            const detail = await fetchData('getNewsDetails', { id: id_berita });
            if (!detail) return;

            const images = [detail.gambar_1, detail.gambar_2, detail.gambar_3].filter(url => url && url.startsWith('http'));
            const date = formatDate(detail.tanggal);

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl">
                    <!-- Close Button -->
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Detail Content -->
                    <div class="p-6">
                        <!-- Image Slider in Modal -->
                        ${images.length > 0 ? `
                            <div class="relative h-64 sm:h-96 overflow-hidden rounded-lg mb-4 bg-gray-100" id="modal-image-carousel">
                                <div class="flex transition-transform duration-500 ease-in-out h-full" id="modal-carousel-track">
                                    ${images.map((img, index) => `
                                        <div class="carousel-item h-full">
                                            <img src="${img}" alt="Gambar Berita ${index + 1}" class="w-full h-full object-contain" 
                                                onerror="this.onerror=null;this.src='https://placehold.co/800x400/9ca3af/ffffff?text=GAMBAR+TIDAK+DITEMUKAN'" loading="lazy">
                                        </div>
                                    `).join('')}
                                </div>
                                ${images.length > 1 ? `
                                    <button class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full" onclick="changeModalSlide(-1)">
                                        <i data-lucide="ChevronLeft" class="w-6 h-6"></i>
                                    </button>
                                    <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full" onclick="changeModalSlide(1)">
                                        <i data-lucide="ChevronRight" class="w-6 h-6"></i>
                                    </button>
                                ` : ''}
                            </div>
                        ` : '<div class="h-10"></div>'}

                        <p class="text-sm font-medium text-gray-500 mb-1">${date}</p>
                        <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-4">${detail.Judul_Berita}</h2>
                        <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">${detail.isi_berita}</div>
                        
                        <!-- Share Button -->
                        <div class="mt-6 border-t pt-4 flex justify-end">
                            <button onclick="shareNews('${detail.id_berita}')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition">
                                <i data-lucide="Share2" class="w-5 h-5 mr-2"></i> Bagikan Link Berita
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalContent;
            showModal();
            lucide.createIcons();

             // Logic untuk modal image slider
            const modalTrack = document.getElementById('modal-carousel-track');
            if (modalTrack) {
                modalCarouselIndex = 0;
                modalTrack.style.transition = 'transform 0.5s ease-in-out';
                modalTrack.style.transform = `translateX(0)`;
            }
        };

        const showModal = () => {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }

        const hideModal = () => {
            const modal = document.getElementById('modal-container');
            modal.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => { modal.innerHTML = ''; }, 300); 
        }

        const shareNews = (id_berita) => {
            const newsLink = `${window.location.origin}${window.location.pathname}#news-${id_berita}`;
            const el = document.createElement('textarea');
            el.value = newsLink;
            document.body.appendChild(el);
            el.select();
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'Link berhasil disalin!' : 'Gagal menyalin link.';
                showNotification(msg, successful ? 'success' : 'error');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showNotification('Gagal menyalin link. Silakan salin manual: ' + newsLink, 'error');
            }
            document.body.removeChild(el);
        }

        let notificationTimeout;
        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('app-content');
            let notification = document.getElementById('notification-box');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification-box';
                notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-[1010] transition-opacity duration-300 opacity-0';
                container.appendChild(notification);
            }

            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-[1010] transition-opacity duration-300 opacity-0 text-white ${bgColor}`;
            notification.textContent = message;

            notification.classList.remove('opacity-0');
            notification.classList.add('opacity-100');

            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 3000);
        }

        // --- CAROUSEL LOGIC (Includes Drag/Swipe) ---
        
        const initCarousel = (totalItems) => {
            carouselTrack = document.getElementById('carousel-track');
            totalCarouselItems = totalItems;
            
            if (!carouselTrack || totalItems < 1) {
                if (carouselInterval) clearInterval(carouselInterval);
                return;
            }

            // Reset drag state
            isDragging = false;
            currentTranslate = 0;
            prevTranslate = 0;
            currentCarouselIndex = 0;
            carouselTrack.style.transition = 'none';
            setSliderPosition();

            // Auto-slide logic
            if (carouselInterval) clearInterval(carouselInterval);
            if (totalItems > 1) {
                carouselInterval = setInterval(() => {
                    currentCarouselIndex = (currentCarouselIndex + 1) % totalItems;
                    currentTranslate = currentCarouselIndex * -carouselTrack.clientWidth;
                    prevTranslate = currentTranslate;
                    carouselTrack.style.transition = 'transform 0.5s ease-in-out';
                    setSliderPosition();
                }, 3000);
            }
        };
        
        const startDrag = (event) => {
            if (totalCarouselItems <= 1) return;

            if (event.type === 'touchstart') {
                startX = event.touches[0].clientX;
            } else { // mousedown
                startX = event.clientX;
                document.body.style.cursor = 'grabbing';
            }
            isDragging = true;
            carouselTrack.style.transition = 'none';
            if (carouselInterval) clearInterval(carouselInterval);
            
            animationID = requestAnimationFrame(animation);
        };

        const onDrag = (event) => {
            if (!isDragging) return;

            let currentX;
            if (event.type === 'touchmove') {
                currentX = event.touches[0].clientX;
            } else { // mousemove
                currentX = event.clientX;
            }
            
            const distance = currentX - startX;
            currentTranslate = prevTranslate + distance;
        };

        const endDrag = (event) => {
            if (!isDragging) return;

            isDragging = false;
            cancelAnimationFrame(animationID);
            
            const movedBy = currentTranslate - prevTranslate;

            // Jika digeser lebih dari 20% lebar slide
            if (movedBy < -carouselTrack.clientWidth / 5 && currentCarouselIndex < totalCarouselItems - 1) {
                currentCarouselIndex++;
            } else if (movedBy > carouselTrack.clientWidth / 5 && currentCarouselIndex > 0) {
                currentCarouselIndex--;
            }
            
            // Atur posisi akhir berdasarkan indeks baru
            currentTranslate = currentCarouselIndex * -carouselTrack.clientWidth;
            prevTranslate = currentTranslate;
            
            carouselTrack.style.transition = 'transform 0.3s ease-in-out';
            setSliderPosition();
            
            // Restart auto-slide
            initCarousel(totalCarouselItems);
            
            document.body.style.cursor = 'default';

            // Mencegah klik saat drag berakhir (hanya untuk mouse events)
            if (event.type === 'mouseup' && Math.abs(movedBy) > 5) {
                event.preventDefault();
            }
        };

        const animation = () => {
            setSliderPosition();
            if (isDragging) requestAnimationFrame(animation);
        };

        const setSliderPosition = () => {
            carouselTrack.style.transform = `translateX(${currentTranslate}px)`;
        };
        
        const changeModalSlide = (direction) => {
            const track = document.getElementById('modal-carousel-track');
            const totalItems = track.children.length;
            
            modalCarouselIndex = (modalCarouselIndex + direction + totalItems) % totalItems;
            track.style.transform = `translateX(-${modalCarouselIndex * 100}%)`;
        };
        
        // --- RENDERING KOMPETISI PAGE ---

        const renderKompetisi = () => {
            const competitions = appData.kompetisi || [];

            let content = renderHeader('Kompetisi');
            content += `
                <div class="p-4 space-y-6">
                    <!-- Kolom Pencarian Kompetisi -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="competition-search" placeholder="Cari Kompetisi/Klub" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Kompetisi', this.value)">
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800">Daftar Kompetisi</h2>
                    <!-- Grid Ringkasan Kompetisi (Nama Kompetisi Saja) -->
                    <div id="competition-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        ${renderCompetitionGrid(competitions)}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderCompetitionGrid = (competitions) => {
            if (competitions.length === 0) {
                return '<p class="col-span-2 sm:col-span-3 text-center text-gray-500">Tidak ada data kompetisi.</p>';
            }

            // Hanya menampilkan nama kompetisi unik untuk grid
            const uniqueCompetitions = [...new Set(competitions.map(c => c.nama_kompetisi))];

            return uniqueCompetitions.map(name => `
                <div class="bg-white rounded-xl shadow-md p-4 flex items-center justify-center text-center h-24 sm:h-32 cursor-pointer transition hover:bg-blue-50 hover:shadow-lg"
                    onclick="showCompetitionListModal('${name}')">
                    <span class="text-base sm:text-lg font-semibold text-gray-800 line-clamp-2">${name}</span>
                </div>
            `).join('');
        };

        const showCompetitionListModal = (competitionName) => {
            const allCompetitions = appData.kompetisi || [];
            const filteredCompetitions = allCompetitions.filter(c => c.nama_kompetisi === competitionName);
            
            const sortedCompetitions = filteredCompetitions.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6">
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">${competitionName}</h2>
                    <div class="space-y-4">
                        ${sortedCompetitions.map(item => renderCompetitionCard(item)).join('')}
                    </div>
                    ${sortedCompetitions.length === 0 ? '<p class="text-center text-gray-500">Tidak ada detail pertandingan untuk kompetisi ini.</p>' : ''}
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalContent;
            showModal();
            lucide.createIcons();
        };

        const renderCompetitionCard = (item) => {
            const date = formatDate(item.tanggal);
            const jenis = item.jenis_pertandingan || 'Pertandingan';
            const lokasi = item.lokasi || 'Tidak diketahui';

            return `
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <span class="text-sm font-semibold text-blue-600">${jenis}</span>
                        <span class="text-sm text-gray-500">${date} @ ${lokasi}</span>
                    </div>
                    
                    <div class="flex items-center justify-between text-center space-x-2">
                        <!-- Klub 1 -->
                        <div class="flex-1 space-y-1">
                            <img src="${item.logo_klub1 || 'https://placehold.co/60x60/f87171/ffffff?text=K1'}" alt="${item.nama_klub1}" class="w-12 h-12 sm:w-16 sm:h-16 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/60x60/f87171/ffffff?text=K1'" loading="lazy">
                            <p class="font-bold text-gray-800 text-sm sm:text-base">${item.nama_klub1 || 'Klub 1'}</p>
                            <p class="text-2xl font-extrabold text-red-600">${item.goal1 !== null && item.goal1 !== '' ? item.goal1 : '?'}</p>
                        </div>
                        
                        <span class="text-lg font-bold text-gray-600">VS</span>

                        <!-- Klub 2 -->
                        <div class="flex-1 space-y-1">
                            <img src="${item.logo_klub2 || 'https://placehold.co/60x60/22c55e/ffffff?text=K2'}" alt="${item.nama_klub2}" class="w-12 h-12 sm:w-16 sm:h-16 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/60x60/22c55e/ffffff?text=K2'" loading="lazy">
                            <p class="font-bold text-gray-800 text-sm sm:text-base">${item.nama_klub2 || 'Klub 2'}</p>
                            <p class="text-2xl font-extrabold text-red-600">${item.goal2 !== null && item.goal2 !== '' ? item.goal2 : '?'}</p>
                        </div>
                    </div>

                    <!-- Detail Statistik -->
                    <div class="mt-4 pt-3 border-t border-gray-200 text-sm">
                        <h4 class="font-semibold text-gray-700 mb-2">Statistik Pertandingan:</h4>
                        <div class="grid grid-cols-2 gap-y-1 gap-x-4">
                            <div class="flex items-center"><i data-lucide="Goal" class="w-4 h-4 mr-1 text-red-500"></i> Gol: ${item.goal1} (${item.Ket_goal1 || '-'})</div>
                            <div class="text-right flex items-center justify-end">Gol: ${item.goal2} (${item.Ket_goal2 || '-'}) <i data-lucide="Goal" class="w-4 h-4 ml-1 text-red-500"></i></div>
                            
                            <div class="flex items-center"><i data-lucide="Square" class="w-4 h-4 mr-1 text-yellow-500"></i> Kuning: ${item.kartu_kuning1} (${item.ket_kartu_kuning1 || '-'})</div>
                            <div class="text-right flex items-center justify-end">Kuning: ${item.kartu_kuning2} (${item.ket_kartu_kuning2 || '-'}) <i data-lucide="Square" class="w-4 h-4 ml-1 text-yellow-500"></i></div>
                            
                            <div class="flex items-center"><i data-lucide="Square" class="w-4 h-4 mr-1 text-red-700 fill-red-700"></i> Merah: ${item.kartu_merah1} (${item.ket_kartu_merah1 || '-'})</div>
                            <div class="text-right flex items-center justify-end">Merah: ${item.kartu_merah2} (${item.ket_kartu_merah2 || '-'}) <i data-lucide="Square" class="w-4 h-4 ml-1 text-red-700 fill-red-700"></i></div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- RENDERING KLUB PAGE ---

        const renderKlub = () => {
            const clubs = appData.klub || [];

            let content = renderHeader('Klub Anggota');
            content += `
                <div class="p-4 space-y-6">
                    <!-- Kolom Pencarian Klub -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="club-search" placeholder="Cari Klub/Julukan" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Klub', this.value)">
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800">Daftar Klub Anggota</h2>
                    <!-- Grid Ringkasan Klub -->
                    <div id="club-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        ${renderClubGrid(clubs)}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderClubGrid = (clubs) => {
            if (clubs.length === 0) {
                return '<p class="col-span-2 sm:col-span-4 text-center text-gray-500">Tidak ada data klub anggota.</p>';
            }

            return clubs.map(club => `
                <div class="bg-white rounded-xl shadow-md p-4 text-center cursor-pointer transition hover:bg-green-50 hover:shadow-lg"
                    onclick="showClubDetailModal('${club.nama_klub}')">
                    <img src="${club.logo_klub || 'https://placehold.co/80x80/10b981/ffffff?text=LOGO'}" alt="${club.nama_klub}" class="w-16 h-16 object-contain mx-auto mb-2 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/80x80/10b981/ffffff?text=LOGO'" loading="lazy">
                    <p class="font-bold text-gray-800 text-sm line-clamp-1">${club.nama_klub}</p>
                    <p class="text-xs text-gray-500 line-clamp-1">"${club.julukan}"</p>
                </div>
            `).join('');
        };

        const showClubDetailModal = async (clubName) => {
            const club = (appData.klub || []).find(c => c.nama_klub === clubName);
            if (!club) return;
            
            // PANGGIL FUNGSI APPS SCRIPT YANG MEMERIKSA NAMA_KLUB1 ATAU NAMA_KLUB2
            const competitions = await fetchData('getCompetitionsByClub', { clubName: clubName });
            
            // Sorting data berdasarkan tanggal terbaru
            const sortedCompetitions = (competitions || []).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6">
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Club Profile Header -->
                    <div class="flex flex-col sm:flex-row items-center sm:items-start border-b pb-4 mb-4">
                        <img src="${club.logo_klub || 'https://placehold.co/100x100/10b981/ffffff?text=LOGO'}" alt="${club.nama_klub}" class="w-24 h-24 object-contain rounded-full mb-3 sm:mb-0 sm:mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/10b981/ffffff?text=LOGO'">
                        <div class="text-center sm:text-left">
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${club.nama_klub}</h2>
                            <p class="text-lg font-semibold text-green-600">"${club.julukan}"</p>
                            <p class="text-sm text-gray-500">Berdiri sejak: ${club.tanggal_berdiri || '-'} | Alamat: ${club.alamat || '-'}</p>
                        </div>
                    </div>
                    
                    <!-- Detail Manajemen -->
                    <h3 class="text-xl font-bold text-gray-800 mb-3 mt-6">Manajemen & Staf</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-700 mb-6">
                        <p><span class="font-semibold">Manajer:</span> ${club.manejer || '-'}</p>
                        <p><span class="font-semibold">Asisten Manajer:</span> ${club.asisten_manejer || '-'}</p>
                        <p><span class="font-semibold">Pelatih Kepala:</span> ${club.pelatih || '-'}</p>
                        <p><span class="font-semibold">Asisten Pelatih:</span> ${club.asisten_pelatih || '-'}</p>
                        <p><span class="font-semibold">Staff Lainnya:</span> ${club.staff_lainnya || '-'}</p>
                        <p><span class="font-semibold">No. HP Klub:</span> ${club.no_handphone_klub || '-'}</p>
                    </div>

                    <!-- Riwayat Kompetisi Klub -->
                    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6 border-t pt-4">Riwayat Pertandingan Terakhir</h3>
                    <div class="space-y-4">
                        ${sortedCompetitions.map(item => renderCompetitionCard(item)).join('')}
                    </div>
                    ${sortedCompetitions.length === 0 ? `<p class="text-center text-gray-500">Klub ${clubName} belum memiliki riwayat pertandingan.</p>` : ''}
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalContent;
            showModal();
            lucide.createIcons();
        };


        // --- RENDERING TENTANG PAGE ---

        const renderTentang = () => {
            const profil = appData.profil || {};
            const struktur = appData.struktur_organisasi || {};
            
            let content = renderHeader('Tentang Kami');
            content += `
                <div class="p-4 space-y-8">
                    
                    <!-- Profil Organisasi -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                        <h2 class="text-2xl font-extrabold text-blue-600 mb-4">${profil.nama_organisasi || 'ASKAB PSSI KEPULAUAN MENTAWAI'}</h2>
                        <p class="text-sm text-gray-500 mb-4">Didirikan sejak: ${profil.tanggal_berdiri || '-'}</p>
                        
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 border-b-2 pb-1 mb-2 flex items-center"><i data-lucide="Eye" class="w-5 h-5 mr-2 text-red-500"></i> Visi</h3>
                                <p class="text-gray-700 whitespace-pre-wrap">${profil.visi || 'Visi belum diisi.'}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 border-b-2 pb-1 mb-2 flex items-center"><i data-lucide="Target" class="w-5 h-5 mr-2 text-green-500"></i> Misi</h3>
                                <p class="text-gray-700 whitespace-pre-wrap">${profil.misi || 'Misi belum diisi.'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Struktur Organisasi -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-600">
                        <h2 class="text-2xl font-extrabold text-green-600 mb-4 flex items-center"><i data-lucide="Users" class="w-6 h-6 mr-2"></i> Struktur Pengurus Inti</h2>
                        
                        <div class="space-y-2">
                            ${renderStructureItem('Ketua Umum', struktur.ketua)}
                            ${renderStructureItem('Wakil Ketua', struktur.wakil_ketua)}
                            ${renderStructureItem('Sekretaris', struktur.sekretaris)}
                            ${renderStructureItem('Bendahara', struktur.bendahara)}
                            ${renderStructureItem('Humas', struktur.humas)}
                            ${renderStructureItem('Media', struktur.media)}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderStructureItem = (role, name) => {
            if (!name) return '';
            return `
                <div class="flex justify-between items-center border-b pb-2">
                    <span class="font-semibold text-gray-700">${role}:</span>
                    <span class="text-lg font-medium text-gray-900">${name}</span>
                </div>
            `;
        }

        // --- FILTERING LOGIC (Search) ---
        
        const filterContent = (page, query) => {
            const normalizedQuery = query.toLowerCase().trim();
            const contentContainer = document.getElementById(page === 'Home' ? 'news-list' : page === 'Kompetisi' ? 'competition-grid' : 'club-grid');
            let filteredItems = [];
            let htmlContent = '';

            if (page === 'Home') {
                const newsData = appData.berita_home || [];
                filteredItems = newsData.filter(item => 
                    item.Judul_Berita && item.Judul_Berita.toLowerCase().includes(normalizedQuery) ||
                    item.isi_berita && item.isi_berita.toLowerCase().includes(normalizedQuery)
                );
                htmlContent = filteredItems.map(item => renderNewsCard(item)).join('');
            } else if (page === 'Kompetisi') {
                const competitions = appData.kompetisi || [];
                // Filter di frontend berdasarkan nama kompetisi, klub 1, atau klub 2
                const filteredCompetitions = competitions.filter(item => 
                    item.nama_kompetisi.toLowerCase().includes(normalizedQuery) ||
                    (item.nama_klub1 && item.nama_klub1.toLowerCase().includes(normalizedQuery)) ||
                    (item.nama_klub2 && item.nama_klub2.toLowerCase().includes(normalizedQuery)) ||
                    (item.jenis_pertandingan && item.jenis_pertandingan.toLowerCase().includes(normalizedQuery))
                );
                htmlContent = renderCompetitionGrid(filteredCompetitions);
            } else if (page === 'Klub') {
                const clubs = appData.klub || [];
                filteredItems = clubs.filter(item => 
                    item.nama_klub.toLowerCase().includes(normalizedQuery) ||
                    item.julukan.toLowerCase().includes(normalizedQuery) ||
                    (item.manejer && item.manejer.toLowerCase().includes(normalizedQuery)) ||
                    (item.pelatih && item.pelatih.toLowerCase().includes(normalizedQuery))
                );
                htmlContent = renderClubGrid(filteredItems);
            }
            
            if (htmlContent === '') {
                htmlContent = `<p class="col-span-full text-center text-gray-500 p-8">Tidak ada hasil yang relevan untuk "${query}".</p>`;
            }

            contentContainer.innerHTML = htmlContent;
            lucide.createIcons();
        };


        // --- NAVIGATION & ROUTING ---

        const navigate = (pageName, skipHistory = false) => {
            if (currentPage === pageName) return;

            currentPage = pageName;
            
            if (!skipHistory) {
                const newUrl = `#${slugify(pageName)}`;
                if (window.location.hash !== newUrl) {
                     window.history.pushState({ page: pageName }, pageName, newUrl);
                }
            }
            
            // Clear auto-slide interval saat pindah halaman
            if (carouselInterval) clearInterval(carouselInterval);
            
            renderPage();
            renderNavBar();
            window.scrollTo(0, 0); 
        };

        const renderPage = () => {
            if (!isDataLoaded) {
                 // Tidak perlu menampilkan pesan loading di sini, sudah dihandle oleh fetchData
                 // Jika fetchData gagal, pesan error sudah ditampilkan
                 return; 
            }

            switch (currentPage) {
                case 'Kompetisi':
                    renderKompetisi();
                    break;
                case 'Klub':
                    renderKlub();
                    break;
                case 'Tentang':
                    renderTentang();
                    break;
                case 'Home':
                default:
                    renderHome();
                    break;
            }
        };

        // --- INITIALIZATION ---

        const initializeApp = async () => {
            startSessionTimer();

            // Tampilkan indikator loading awal saat fetch data
            document.getElementById('app-content').innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <div class="spinner mx-auto mb-3"></div>
                    <p>Mencoba mengambil data dari Google Sheet...</p>
                </div>
            `;
            
            const data = await fetchData('getInitialData');
            
            if (data) {
                appData = data;
                isDataLoaded = true;
                
                // Cek sekali lagi apakah data berita ada setelah loading
                if (appData.berita_home && appData.berita_home.length > 0) {
                     console.log("SUKSES: Berita telah dimuat. Jumlah:", appData.berita_home.length);
                } else {
                    console.log("INFO: Data berita kosong atau Apps Script gagal mengambilnya.");
                }

                const hash = window.location.hash.slice(1);
                if (hash) {
                    const routeMap = {
                        'home': 'Home',
                        'kompetisi': 'Kompetisi',
                        'klub': 'Klub',
                        'tentang': 'Tentang'
                    };
                    currentPage = routeMap[hash] || 'Home';
                } else {
                    currentPage = 'Home';
                }
                
                renderPage();
                renderNavBar();
            } else {
                // Jika fetch gagal, pesan error sudah ditampilkan di fetchData, jadi jangan render halaman lain.
            }

        };

        // --- History API Listener (Mengatasi tombol back) ---
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.page) {
                navigate(event.state.page, true); 
            } else {
                if (currentPage !== 'Home') {
                    navigate('Home', true);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
        
    </script>
</body>
</html>

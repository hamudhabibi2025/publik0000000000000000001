<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon (misalnya, tombol bagikan) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --pssi-blue: #0A369D;
            --pssi-gold: #FFD700;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .nav-active { border-color: var(--pssi-gold); color: var(--pssi-gold); }
        .loading-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px; background-color: var(--pssi-gold);
            transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease-in-out; z-index: 50;
        }
        .loading-bar.active { transform: scaleX(1); }

        /* Kustomisasi scrollbar untuk tampilan yang lebih baik */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f4f7f6; }
        ::-webkit-scrollbar-thumb { background: var(--pssi-blue); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--pssi-gold); }

        /* CSS untuk Carousel Banner */
        .carousel-item { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Loading Bar -->
    <div id="loading-bar" class="loading-bar"></div>

    <!-- Main Content Area -->
    <div id="app-container" class="flex-grow pb-20 md:pb-0">
        <!-- Header (Akan diisi dinamis oleh JS) -->
        <header id="app-header" class="sticky top-0 bg-white shadow-md z-30 p-3 flex items-center justify-between transition-all duration-300">
            <!-- Isi header dimuat di JS -->
        </header>

        <!-- Main Content (Tempat Halaman dimuat) -->
        <main id="page-content" class="p-4 md:p-6 max-w-7xl mx-auto w-full">
            <!-- Konten halaman dimuat di sini -->
        </main>
    </div>

    <!-- Modal Detail Berita -->
    <div id="news-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" onclick="closeNewsModal()">
        <div id="news-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-3xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <!-- Konten modal dimuat di sini -->
        </div>
    </div>

    <!-- Modal Detail Klub -->
    <div id="club-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" onclick="closeClubModal()">
        <div id="club-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-3xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <!-- Konten modal dimuat di sini -->
        </div>
    </div>

    <!-- Navigasi Bawah (Hanya untuk Mobile) -->
    <nav id="mobile-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-40 md:hidden flex justify-around p-2">
        <!-- Tombol navigasi dimuat di sini -->
    </nav>
    
    <!-- Navigasi Samping (Hanya untuk Desktop) -->
    <nav id="desktop-nav" class="hidden md:flex fixed top-0 left-0 h-full w-48 bg-white shadow-lg p-4 flex-col justify-start z-40 pt-20">
        <!-- Tombol navigasi dimuat di sini -->
    </nav>

    <script>
        // --- KONFIGURASI DAN INICIALISASI GLOBAL ---
        
        // PENTING: GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzOg72W2KRNKKeXU5L57tIWScMoeVBLeD3KcZoX0QmuA842tw6y5BHfhq77L3GKYL7b/exec'; // Contoh: 'https://script.google.com/macros/s/AKfyc.../exec'
        
        const APP_ID = 'ASKAB_PSSI_MENTAWAI'; // ID unik untuk sesi

        let allData = {
            kepala_halaman: null,
            banner: [],
            berita_home: [],
            kompetisi: [],
            klub: [],
            profil: null,
            struktur_organisasi: null
        };

        let currentPage = 'Home';
        let loadingState = false;
        let sessionTimer = null;
        let bannerInterval = null;

        // Mendapatkan URL API dengan parameter sheet
        const getApiUrl = (sheetName, id = null) => {
            let url = `${SCRIPT_URL}?sheet=${sheetName}`;
            if (id) {
                url += `&id=${encodeURIComponent(id)}`;
            }
            return url;
        };

        // --- UTILITY FUNCTIONS ---

        // Menampilkan/Menyembunyikan Loading Bar
        const showLoading = (show) => {
            const loadingBar = document.getElementById('loading-bar');
            loadingState = show;
            if (show) {
                loadingBar.classList.add('active');
            } else {
                loadingBar.classList.remove('active');
            }
        };

        // Fungsi Generik untuk Mengambil Data
        const fetchData = async (sheetName, id = null) => {
            showLoading(true);
            try {
                const url = getApiUrl(sheetName, id);
                if (!SCRIPT_URL) {
                    throw new Error("URL API SCRIPT BELUM DIATUR. Mohon ganti SCRIPT_URL di index.html.");
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Gagal mengambil data dari ${sheetName}: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(`Apps Script Error: ${data.error}`);
                }
                return data;
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                const pageContent = document.getElementById('page-content');
                pageContent.innerHTML = `<div class="text-red-600 p-4 bg-red-100 rounded-lg">Kesalahan saat mengambil data. Pastikan URL Apps Script sudah benar dan Web App sudah di-deploy dengan akses 'Anyone'. Error: ${error.message}</div>`;
                return sheetName === 'kepala_halaman' ? {} : (Array.isArray(allData[sheetName]) ? [] : null);
            } finally {
                showLoading(false);
            }
        };

        // Mengatur dan me-render Header
        const renderHeader = () => {
            const headerData = allData.kepala_halaman;
            const headerEl = document.getElementById('app-header');

            if (!headerData) {
                headerEl.innerHTML = `<h1 class="text-xl font-bold text-pssi-blue">ASKAB PSSI KEPULAUAN MENTAWAI</h1>`;
                return;
            }

            headerEl.innerHTML = `
                <img src="${headerData.logo_pssi || 'https://placehold.co/40x40/0A369D/ffffff?text=PSSI'}" onerror="this.src='https://placehold.co/40x40/0A369D/ffffff?text=PSSI'" alt="Logo PSSI" class="h-10 w-10 object-contain rounded-full">
                <h1 class="text-lg md:text-xl font-extrabold text-pssi-blue text-center flex-grow mx-2">${headerData.judul_kepala || 'ASKAB PSSI KEPULAUAN MENTAWAI'}</h1>
                <img src="${headerData.logo_askab || 'https://placehold.co/40x40/FFD700/0A369D?text=ASKAB'}" onerror="this.src='https://placehold.co/40x40/FFD700/0A369D?text=ASKAB'" alt="Logo ASKAB" class="h-10 w-10 object-contain rounded-full">
            `;
        };

        // Mengatur dan me-render Navigasi
        const renderNavigation = () => {
            const navItems = [
                { name: 'Home', icon: 'fas fa-home' },
                { name: 'Kompetisi', icon: 'fas fa-trophy' },
                { name: 'Klub', icon: 'fas fa-shield-alt' },
                { name: 'Tentang', icon: 'fas fa-info-circle' }
            ];

            const createNavItem = (item, isMobile) => {
                const isActive = item.name === currentPage;
                const baseClasses = "flex items-center justify-center p-2 rounded-lg transition-colors duration-200 text-gray-500 hover:text-pssi-blue font-semibold";
                const activeClasses = isActive ? "text-pssi-blue border-b-2 border-pssi-gold" : "";
                
                return `
                    <button onclick="changePage('${item.name}')" class="${baseClasses} ${activeClasses} ${isMobile ? 'flex-col space-y-1' : 'w-full justify-start space-x-2'}">
                        <i class="${item.icon} ${isMobile ? 'text-xl' : 'text-lg'}"></i>
                        <span class="${isMobile ? 'text-xs' : 'text-sm'}">${item.name}</span>
                    </button>
                `;
            };

            const mobileNavEl = document.getElementById('mobile-nav');
            mobileNavEl.innerHTML = navItems.map(item => createNavItem(item, true)).join('');

            const desktopNavEl = document.getElementById('desktop-nav');
            desktopNavEl.innerHTML = `
                <div class="text-sm font-bold text-gray-400 mb-4 uppercase">Navigasi</div>
                ${navItems.map(item => createNavItem(item, false)).join('')}
            `;

            // Atur padding content agar tidak tertutup nav desktop
            const appContainer = document.getElementById('app-container');
            const headerEl = document.getElementById('app-header');
            const isDesktop = window.innerWidth >= 768;

            if (isDesktop) {
                appContainer.style.paddingLeft = '12rem'; // Padding sesuai lebar nav desktop
                headerEl.classList.remove('sticky', 'top-0');
                headerEl.classList.add('relative', 'md:ml-48');
            } else {
                appContainer.style.paddingLeft = '0';
                headerEl.classList.add('sticky', 'top-0');
                headerEl.classList.remove('md:ml-48');
            }
        };

        // Fungsi Pager (Mengganti Halaman)
        const changePage = (page) => {
            if (loadingState) return;
            currentPage = page;
            renderNavigation();
            renderPage(page);
        };

        // Timer Sesi (30 Menit)
        const startSessionTimer = () => {
            if (sessionTimer) clearTimeout(sessionTimer);
            
            // Konfigurasi 30 menit (30 * 60 * 1000 ms)
            const thirtyMinutes = 30 * 60 * 1000; 

            sessionTimer = setTimeout(() => {
                // Tampilkan pesan dan muat ulang
                alert('Sesi pengunjung telah berakhir (30 menit). Halaman akan dimuat ulang untuk memperbarui data.');
                window.location.reload();
            }, thirtyMinutes);

            console.log('Session timer started for 30 minutes.');
        };

        // --- RENDER HALAMAN ---

        const renderPage = async (page) => {
            const contentEl = document.getElementById('page-content');
            contentEl.innerHTML = `<div class="flex justify-center items-center h-48 text-pssi-blue"><i class="fas fa-spinner fa-spin text-4xl"></i></div>`; // Loading placeholder

            if (!allData.kepala_halaman) {
                await initData();
            }

            switch (page) {
                case 'Home':
                    renderHomePage(contentEl);
                    break;
                case 'Kompetisi':
                    renderKompetisiPage(contentEl);
                    break;
                case 'Klub':
                    renderKlubPage(contentEl);
                    break;
                case 'Tentang':
                    renderTentangPage(contentEl);
                    break;
                default:
                    contentEl.innerHTML = `<div class="text-center p-8">Halaman tidak ditemukan.</div>`;
            }
        };

        // Helper: Format Tanggal
        const formatDate = (dateValue) => {
            if (!dateValue) return 'TBD';
            const date = new Date(dateValue);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        };

        // ----------------------------------------------------
        // HOME PAGE
        // ----------------------------------------------------

        const renderHomePage = async (contentEl) => {
            // Muat data jika belum ada
            if (allData.banner.length === 0) {
                allData.banner = await fetchData('banner');
            }
            if (allData.berita_home.length === 0) {
                allData.berita_home = await fetchData('berita_home');
            }

            contentEl.innerHTML = `
                <!-- Search Bar -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <input type="text" id="news-search-input" onkeyup="filterNews()" placeholder="Cari Berita..." 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pssi-blue">
                </div>

                <!-- Banner Carousel Area -->
                <div id="banner-carousel" class="relative w-full h-48 md:h-80 overflow-hidden rounded-xl shadow-lg mb-8 bg-gray-200">
                    <!-- Carousel Items go here -->
                </div>

                <!-- News List -->
                <h2 class="text-2xl font-bold text-pssi-blue mb-4 border-b-2 border-pssi-gold pb-1">Berita Terbaru</h2>
                <div id="news-list" class="space-y-6">
                    <!-- News Cards go here -->
                </div>
            `;

            renderBanner();
            renderNewsList(allData.berita_home);
        };

        const renderBanner = () => {
            const bannerEl = document.getElementById('banner-carousel');
            if (!bannerEl || allData.banner.length === 0) return;

            // Dapatkan URL gambar dari data banner (poto-1, poto-2, poto-3)
            const bannerImages = [];
            if (allData.banner[0]) {
                ['poto_1', 'poto_2', 'poto_3'].forEach(key => {
                    if (allData.banner[0][key]) {
                        bannerImages.push(allData.banner[0][key]);
                    }
                });
            }

            if (bannerImages.length === 0) {
                bannerEl.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">Banner Tidak Tersedia</div>`;
                return;
            }

            bannerEl.innerHTML = bannerImages.map((url, index) => `
                <div class="carousel-item absolute inset-0 transition-opacity duration-700 ${index === 0 ? 'opacity-100' : 'opacity-0'}" data-index="${index}">
                    <img src="${url}" onerror="this.onerror=null;this.src='https://placehold.co/1200x480/cccccc/333333?text=Banner+Gagal+Muat'" alt="Banner ${index + 1}" class="w-full h-full object-cover">
                </div>
            `).join('');

            // Logic Carousel
            let currentBannerIndex = 0;
            const items = bannerEl.querySelectorAll('.carousel-item');
            const showBanner = (index) => {
                items.forEach((item, i) => {
                    item.classList.toggle('opacity-100', i === index);
                    item.classList.toggle('opacity-0', i !== index);
                });
            };

            const nextBanner = () => {
                currentBannerIndex = (currentBannerIndex + 1) % bannerImages.length;
                showBanner(currentBannerIndex);
            };

            if (bannerInterval) clearInterval(bannerInterval);
            bannerInterval = setInterval(nextBanner, 5000); // Ganti setiap 5 detik
        };

        const filterNews = () => {
            const query = document.getElementById('news-search-input').value.toLowerCase();
            const filtered = allData.berita_home.filter(news =>
                news.Judul_Berita.toLowerCase().includes(query) ||
                news.isi_berita.toLowerCase().includes(query)
            );
            renderNewsList(filtered);
        };

        const renderNewsList = (newsList) => {
            const newsListEl = document.getElementById('news-list');
            if (!newsListEl) return;

            if (newsList.length === 0) {
                newsListEl.innerHTML = `<div class="text-center p-8 text-gray-500">Tidak ada berita yang ditemukan.</div>`;
                return;
            }

            newsListEl.innerHTML = newsList.map(news => {
                // Ambil 20 kata pertama
                const summary = news.isi_berita ? news.isi_berita.split(/\s+/).slice(0, 20).join(' ') + '...' : 'Tidak ada isi berita.';
                
                // Ambil semua gambar (gambar_1, gambar_2, gambar_3)
                const images = [news.gambar_1, news.gambar_2, news.gambar_3].filter(url => url);
                const firstImage = images[0] || 'https://placehold.co/400x200/cccccc/333333?text=Gambar+Berita';

                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row cursor-pointer hover:shadow-xl transition-shadow duration-300" onclick="openNewsModal('${news.id_berita}')">
                        <div class="md:w-1/3 h-48 md:h-auto overflow-hidden">
                            <img src="${firstImage}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=Gambar+Berita'" alt="${news.Judul_Berita}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105">
                        </div>
                        <div class="p-4 md:w-2/3">
                            <p class="text-sm text-gray-500 mb-1">${formatDate(news.tanggal)}</p>
                            <h3 class="text-xl font-bold text-pssi-blue mb-2">${news.Judul_Berita}</h3>
                            <p class="text-gray-600">${summary}</p>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // --- MODAL BERITA ---

        const openNewsModal = (id) => {
            const news = allData.berita_home.find(n => n.id_berita === id);
            if (!news) return;

            const modalEl = document.getElementById('news-modal');
            const modalContentEl = document.getElementById('news-modal-content');
            
            const images = [news.gambar_1, news.gambar_2, news.gambar_3].filter(url => url);

            modalContentEl.innerHTML = `
                <div class="relative">
                    <button onclick="closeNewsModal()" class="absolute top-3 right-3 text-white bg-black bg-opacity-50 rounded-full p-2 z-10 hover:bg-opacity-80">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <!-- Image Carousel in Modal -->
                    <div id="modal-image-carousel" class="relative h-64 md:h-80 overflow-hidden bg-gray-200">
                        ${images.map((url, index) => `
                            <img src="${url}" onerror="this.onerror=null;this.src='https://placehold.co/800x400/cccccc/333333?text=Gambar+Berita'" alt="Berita Gambar ${index + 1}" class="carousel-item absolute inset-0 w-full h-full object-cover transition-opacity duration-700 ${index === 0 ? 'opacity-100' : 'opacity-0'}" data-modal-index="${index}">
                        `).join('')}
                        ${images.length > 1 ? `
                            <button onclick="prevModalImage(event)" class="absolute left-0 top-1/2 transform -translate-y-1/2 text-white p-3 bg-black bg-opacity-50 rounded-r-lg hover:bg-opacity-75"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="nextModalImage(event)" class="absolute right-0 top-1/2 transform -translate-y-1/2 text-white p-3 bg-black bg-opacity-50 rounded-l-lg hover:bg-opacity-75"><i class="fas fa-chevron-right"></i></button>
                        ` : ''}
                    </div>

                    <div class="p-6">
                        <p class="text-sm text-gray-500 mb-1">${formatDate(news.tanggal)}</p>
                        <h2 class="text-2xl font-extrabold text-pssi-blue mb-4">${news.Judul_Berita}</h2>
                        <div class="prose max-w-none mb-6">
                            <p>${news.isi_berita.replace(/\n/g, '<br>')}</p>
                        </div>
                        
                        <!-- Share Button -->
                        <div class="flex justify-end space-x-3">
                            <a href="https://wa.me/?text=${encodeURIComponent(`[ASKAB PSSI Mentawai] Berita: ${news.Judul_Berita} - [Link Berita Placeholder: Salin tautan ini]`)}" target="_blank" class="text-white bg-green-500 hover:bg-green-600 rounded-full p-3 transition-colors duration-200" title="Bagikan ke WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('Link Berita Placeholder')}" target="_blank" class="text-white bg-blue-700 hover:bg-blue-800 rounded-full p-3 transition-colors duration-200" title="Bagikan ke Facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Link Berita Placeholder adalah URL saat ini. Dalam implementasi nyata, ganti dengan URL berita spesifik.</p>
                    </div>
                </div>
            `;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');

            // Logic Modal Carousel
            let currentModalImageIndex = 0;
            const modalItems = document.querySelectorAll('#modal-image-carousel img');
            window.showModalImage = (index) => {
                modalItems.forEach((item, i) => {
                    item.classList.toggle('opacity-100', i === index);
                    item.classList.toggle('opacity-0', i !== index);
                });
            };
            window.nextModalImage = (e) => {
                e.stopPropagation();
                currentModalImageIndex = (currentModalImageIndex + 1) % images.length;
                window.showModalImage(currentModalImageIndex);
            };
            window.prevModalImage = (e) => {
                e.stopPropagation();
                currentModalImageIndex = (currentModalImageIndex - 1 + images.length) % images.length;
                window.showModalImage(currentModalImageIndex);
            };
        };

        const closeNewsModal = () => {
            const modalEl = document.getElementById('news-modal');
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
        };

        // ----------------------------------------------------
        // KOMPETISI PAGE
        // ----------------------------------------------------
        
        let selectedCompetitionType = null;

        const renderKompetisiPage = async (contentEl) => {
            if (allData.kompetisi.length === 0) {
                allData.kompetisi = await fetchData('kompetisi');
            }

            contentEl.innerHTML = `
                <!-- Search Bar -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <input type="text" id="competition-search-input" onkeyup="filterCompetitions()" placeholder="Cari Kompetisi atau Pertandingan..." 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pssi-blue">
                </div>
                
                <h2 class="text-2xl font-bold text-pssi-blue mb-4 border-b-2 border-pssi-gold pb-1">Jenis Kompetisi</h2>
                <div id="competition-type-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Competition Type Cards go here -->
                </div>

                <h2 class="text-2xl font-bold text-pssi-blue mb-4 border-b-2 border-pssi-gold pb-1">Jadwal Pertandingan ${selectedCompetitionType ? `(${selectedCompetitionType})` : 'Semua'}</h2>
                <div id="competition-list" class="space-y-4">
                    <!-- Competition Event Cards go here -->
                </div>
            `;

            renderCompetitionTypeGrid(allData.kompetisi);
            renderCompetitionEvents(allData.kompetisi);
        };

        const renderCompetitionTypeGrid = (competitions) => {
            const gridEl = document.getElementById('competition-type-grid');
            if (!gridEl) return;

            // Dapatkan jenis pertandingan unik
            const uniqueTypes = [...new Set(competitions.map(c => c.nama_kompetisi))];

            gridEl.innerHTML = uniqueTypes.map(type => {
                const isActive = type === selectedCompetitionType;
                const activeClasses = isActive ? 'bg-pssi-blue text-white shadow-xl scale-[1.02]' : 'bg-white text-pssi-blue hover:shadow-lg hover:border-pssi-gold';
                return `
                    <button onclick="selectCompetitionType('${type}')" class="p-4 border-2 border-pssi-blue rounded-xl font-semibold text-center transition-all duration-200 ${activeClasses}">
                        ${type}
                    </button>
                `;
            }).join('');

             // Tambahkan tombol reset
             gridEl.innerHTML += `
                <button onclick="selectCompetitionType(null)" class="p-4 border-2 border-gray-400 rounded-xl font-semibold text-center transition-all duration-200 ${selectedCompetitionType === null ? 'bg-gray-700 text-white shadow-xl scale-[1.02]' : 'bg-white text-gray-700 hover:shadow-lg hover:border-gray-500'}">
                    Semua
                </button>
            `;
        };

        const selectCompetitionType = (type) => {
            selectedCompetitionType = type;
            renderKompetisiPage(document.getElementById('page-content')); // Render ulang halaman kompetisi
        };

        const filterCompetitions = () => {
            const query = document.getElementById('competition-search-input').value.toLowerCase();
            const filtered = allData.kompetisi.filter(comp =>
                (comp.nama_kompetisi.toLowerCase().includes(query) ||
                comp.jenis_pertandingan.toLowerCase().includes(query) ||
                comp.nama_klub1.toLowerCase().includes(query) ||
                comp.nama_klub2.toLowerCase().includes(query) ||
                comp.lokasi.toLowerCase().includes(query)) &&
                (selectedCompetitionType ? comp.nama_kompetisi === selectedCompetitionType : true)
            );
            renderCompetitionEvents(filtered);
        };

        const renderCompetitionEvents = (competitionList) => {
            const listEl = document.getElementById('competition-list');
            if (!listEl) return;

            // Filter berdasarkan jenis yang dipilih
            const filteredList = selectedCompetitionType 
                ? competitionList.filter(c => c.nama_kompetisi === selectedCompetitionType) 
                : competitionList;
            
            if (filteredList.length === 0) {
                listEl.innerHTML = `<div class="text-center p-8 text-gray-500">Tidak ada jadwal pertandingan yang ditemukan.</div>`;
                return;
            }

            listEl.innerHTML = filteredList.map(comp => `
                <div class="bg-white rounded-xl shadow-lg p-4 transition-shadow duration-300 hover:shadow-xl border-t-4 border-pssi-blue">
                    <p class="text-sm font-semibold text-gray-500 mb-2">${comp.nama_kompetisi} - ${comp.jenis_pertandingan}</p>
                    
                    <div class="flex items-center justify-between text-center">
                        <!-- Klub 1 -->
                        <div class="w-2/5 flex flex-col items-center">
                            <img src="${comp.logo_klub1 || 'https://placehold.co/60x60/0A369D/ffffff?text=KLUB1'}" onerror="this.src='https://placehold.co/60x60/0A369D/ffffff?text=KLUB1'" alt="${comp.nama_klub1}" class="h-12 w-12 md:h-16 md:w-16 object-contain rounded-full mb-1">
                            <p class="font-bold text-lg text-pssi-blue truncate w-full">${comp.nama_klub1}</p>
                        </div>

                        <!-- Skor & Info -->
                        <div class="w-1/5 flex flex-col items-center">
                            <p class="text-2xl md:text-4xl font-extrabold text-pssi-gold mb-1">
                                ${comp.goal1 || '0'} - ${comp.goal2 || '0'}
                            </p>
                            <p class="text-xs text-gray-600 font-semibold mb-2">${formatDate(comp.tanggal)}</p>
                            <p class="text-sm text-gray-500 truncate"><i class="fas fa-map-marker-alt mr-1"></i> ${comp.lokasi}</p>
                        </div>
                        
                        <!-- Klub 2 -->
                        <div class="w-2/5 flex flex-col items-center">
                            <img src="${comp.logo_klub2 || 'https://placehold.co/60x60/FFD700/0A369D?text=KLUB2'}" onerror="this.src='https://placehold.co/60x60/FFD700/0A369D?text=KLUB2'" alt="${comp.nama_klub2}" class="h-12 w-12 md:h-16 md:w-16 object-contain rounded-full mb-1">
                            <p class="font-bold text-lg text-pssi-blue truncate w-full">${comp.nama_klub2}</p>
                        </div>
                    </div>
                    
                    <!-- Detail Kartu/Merah (Sederhana) -->
                    <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-600 flex justify-around">
                        <p class="flex items-center"><i class="fas fa-square text-yellow-500 mr-1"></i> KK: ${comp.kartu_kuning1 || 0} - ${comp.kartu_kuning2 || 0}</p>
                        <p class="flex items-center"><i class="fas fa-square text-red-600 mr-1"></i> KM: ${comp.kartu_merah1 || 0} - ${comp.kartu_merah2 || 0}</p>
                        <p class="flex items-center"><i class="fas fa-futbol text-pssi-blue mr-1"></i> Goal: ${comp.goal1 || 0} - ${comp.goal2 || 0}</p>
                    </div>
                </div>
            `).join('');
        };


        // ----------------------------------------------------
        // KLUB PAGE
        // ----------------------------------------------------
        
        let selectedClub = null;

        const renderKlubPage = async (contentEl) => {
            if (allData.klub.length === 0) {
                allData.klub = await fetchData('klub');
            }
            if (allData.kompetisi.length === 0) {
                allData.kompetisi = await fetchData('kompetisi');
            }

            contentEl.innerHTML = `
                <!-- Search Bar -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg">
                    <input type="text" id="club-search-input" onkeyup="filterClubs()" placeholder="Cari Nama Klub atau Julukan..." 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pssi-blue">
                </div>
                
                <h2 class="text-2xl font-bold text-pssi-blue mb-4 border-b-2 border-pssi-gold pb-1">Daftar Klub</h2>
                <div id="club-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Club Grid Cards go here -->
                </div>
            `;

            renderClubGrid(allData.klub);
        };

        const filterClubs = () => {
            const query = document.getElementById('club-search-input').value.toLowerCase();
            const filtered = allData.klub.filter(club =>
                club.nama_klub.toLowerCase().includes(query) ||
                club.julukan.toLowerCase().includes(query)
            );
            renderClubGrid(filtered);
        };

        const renderClubGrid = (clubList) => {
            const gridEl = document.getElementById('club-grid');
            if (!gridEl) return;

            if (clubList.length === 0) {
                gridEl.innerHTML = `<div class="text-center p-8 col-span-2 md:col-span-4 text-gray-500">Tidak ada klub yang ditemukan.</div>`;
                return;
            }

            gridEl.innerHTML = clubList.map(club => `
                <div onclick="openClubModal('${club.id_klub}')" class="bg-white rounded-xl shadow-lg p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transition-shadow duration-300 hover:border-pssi-blue border border-transparent">
                    <img src="${club.logo_klub || 'https://placehold.co/80x80/0A369D/ffffff?text=LOGO'}" onerror="this.src='https://placehold.co/80x80/0A369D/ffffff?text=LOGO'" alt="${club.nama_klub}" class="h-16 w-16 object-contain rounded-full mb-2">
                    <p class="font-bold text-pssi-blue truncate w-full">${club.nama_klub}</p>
                    <p class="text-xs text-gray-500 italic">${club.julukan}</p>
                </div>
            `).join('');
        };

        // --- MODAL KLUB ---

        const openClubModal = async (id) => {
            selectedClub = allData.klub.find(c => c.id_klub === id);
            if (!selectedClub) return;

            const modalEl = document.getElementById('club-modal');
            const modalContentEl = document.getElementById('club-modal-content');
            
            modalContentEl.innerHTML = `
                <div class="relative p-6">
                    <button onclick="closeClubModal()" class="absolute top-3 right-3 text-gray-600 hover:text-red-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    
                    <!-- Club Detail Header -->
                    <div class="flex flex-col items-center mb-6 border-b pb-4">
                        <img src="${selectedClub.logo_klub || 'https://placehold.co/100x100/0A369D/ffffff?text=LOGO'}" onerror="this.src='https://placehold.co/100x100/0A369D/ffffff?text=LOGO'" alt="${selectedClub.nama_klub}" class="h-20 w-20 object-contain rounded-full mb-3 shadow-lg p-1 bg-white">
                        <h2 class="text-3xl font-extrabold text-pssi-blue">${selectedClub.nama_klub}</h2>
                        <p class="text-lg italic text-pssi-gold">${selectedClub.julukan}</p>
                    </div>

                    <!-- Club Information Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">Berdiri:</span> ${formatDate(selectedClub.tanggal_berdiri)}</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">Manajer:</span> ${selectedClub.manejer}</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">Pelatih:</span> ${selectedClub.pelatih}</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">Asisten Pelatih:</span> ${selectedClub.asisten_pelatih}</div>
                        <div class="p-3 bg-gray-50 rounded-lg md:col-span-2"><span class="font-semibold text-pssi-blue">Alamat:</span> ${selectedClub.alamat}</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">Asisten Manajer:</span> ${selectedClub.asisten_manejer}</div>
                        <div class="p-3 bg-gray-50 rounded-lg"><span class="font-semibold text-pssi-blue">No. HP Klub:</span> ${selectedClub.no_handphone_klub}</div>
                    </div>

                    <!-- Competition History for the Club -->
                    <h3 class="text-xl font-bold text-pssi-blue mb-3 border-b-2 border-pssi-gold pb-1">Riwayat Pertandingan</h3>
                    <div id="club-competition-history" class="space-y-3">
                        <!-- Competition list filtered by club will be loaded here -->
                        <div class="text-center text-gray-500">Memuat data pertandingan...</div>
                    </div>
                </div>
            `;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
            
            // Muat riwayat pertandingan klub
            renderClubCompetitionHistory(selectedClub.nama_klub);
        };

        const renderClubCompetitionHistory = async (clubName) => {
            const historyEl = document.getElementById('club-competition-history');
            if (!historyEl) return;

            // Memfilter data kompetisi yang sudah ada di memori
            const clubCompetitions = allData.kompetisi.filter(comp => 
                comp.nama_klub1 === clubName || comp.nama_klub2 === clubName
            );

            if (clubCompetitions.length === 0) {
                historyEl.innerHTML = `<div class="text-center p-4 text-gray-500 bg-gray-50 rounded-lg">Klub ini belum terdaftar di jadwal pertandingan manapun.</div>`;
                return;
            }

            historyEl.innerHTML = clubCompetitions.map(comp => {
                const isHome = comp.nama_klub1 === clubName;
                const opponentName = isHome ? comp.nama_klub2 : comp.nama_klub1;
                const clubScore = isHome ? comp.goal1 : comp.goal2;
                const oppScore = isHome ? comp.goal2 : comp.goal1;
                
                let resultClass = 'bg-gray-200';
                let resultText = 'VS';
                if (clubScore !== null && oppScore !== null) {
                    if (clubScore > oppScore) { resultClass = 'bg-green-100 border-l-4 border-green-500'; resultText = 'MENANG'; }
                    else if (clubScore < oppScore) { resultClass = 'bg-red-100 border-l-4 border-red-500'; resultText = 'KALAH'; }
                    else { resultClass = 'bg-yellow-100 border-l-4 border-yellow-500'; resultText = 'SERI'; }
                }

                return `
                    <div class="p-3 rounded-lg shadow-sm ${resultClass}">
                        <p class="text-xs font-semibold text-gray-500">${comp.nama_kompetisi} - ${formatDate(comp.tanggal)}</p>
                        <div class="flex justify-between items-center mt-1">
                            <p class="font-bold text-sm">${clubName}</p>
                            <p class="text-lg font-extrabold mx-2 text-pssi-blue">${clubScore || '?'} - ${oppScore || '?'}</p>
                            <p class="font-bold text-sm">${opponentName}</p>
                        </div>
                        <p class="text-xs text-right mt-1 italic">${resultText}</p>
                    </div>
                `;
            }).join('');
        };

        const closeClubModal = () => {
            const modalEl = document.getElementById('club-modal');
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
        };

        // ----------------------------------------------------
        // TENTANG PAGE
        // ----------------------------------------------------

        const renderTentangPage = async (contentEl) => {
            if (!allData.profil) {
                allData.profil = await fetchData('profil');
            }
            if (!allData.struktur_organisasi) {
                allData.struktur_organisasi = await fetchData('struktur_organisasi');
            }

            const profil = allData.profil || {};
            const struktur = allData.struktur_organisasi || {};

            contentEl.innerHTML = `
                <!-- Bagian Profil Organisasi -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-3xl font-bold text-pssi-blue mb-4 border-b-4 border-pssi-gold pb-2">${profil.nama_organisasi || 'ASKAB PSSI KEPULAUAN MENTAWAI'}</h2>
                    <p class="text-sm text-gray-500 mb-6">Berdiri sejak: ${formatDate(profil.tanggal_berdiri)}</p>

                    <!-- Visi -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-pssi-blue mb-2 flex items-center"><i class="fas fa-eye mr-2"></i> Visi</h3>
                        <div class="p-4 bg-blue-50 rounded-lg italic">${profil.visi || 'Visi belum tersedia.'}</div>
                    </div>

                    <!-- Misi -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-pssi-blue mb-2 flex items-center"><i class="fas fa-bullseye mr-2"></i> Misi</h3>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            ${profil.misi ? profil.misi.split('\n').map(m => `<p class="mb-1">${m}</p>`).join('') : 'Misi belum tersedia.'}
                        </div>
                    </div>
                </div>

                <!-- Bagian Struktur Organisasi -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-3xl font-bold text-pssi-blue mb-4 border-b-4 border-pssi-gold pb-2">Pengurus Inti</h2>
                    
                    <div class="space-y-3">
                        ${renderStrukturItem('Ketua', struktur.ketua)}
                        ${renderStrukturItem('Wakil Ketua', struktur.wakil_ketua)}
                        ${renderStrukturItem('Sekretaris', struktur.sekretaris)}
                        ${renderStrukturItem('Bendahara', struktur.bendahara)}
                        ${renderStrukturItem('Humas', struktur.humas)}
                        ${renderStrukturItem('Media', struktur.media)}
                    </div>
                </div>
            `;
        };

        const renderStrukturItem = (jabatan, nama) => {
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-semibold text-pssi-blue">${jabatan}:</span>
                    <span class="text-gray-700">${nama || 'TBD'}</span>
                </div>
            `;
        };
        
        // --- INICIALISASI APLIKASI ---

        // Fungsi inisialisasi awal (memuat header dan data statis)
        const initData = async () => {
            // Muat data header dan statis lainnya secara paralel
            const [kepala, profil, struktur] = await Promise.all([
                fetchData('kepala_halaman'),
                fetchData('profil'),
                fetchData('struktur_organisasi')
            ]);
            
            allData.kepala_halaman = kepala;
            allData.profil = profil;
            allData.struktur_organisasi = struktur;

            renderHeader();
        };

        // Fungsi yang dipanggil saat halaman dimuat
        const initApp = async () => {
            showLoading(true);

            // 1. Muat data awal yang dibutuhkan untuk header
            await initData();
            
            // 2. Set halaman default dan render
            changePage('Home');
            
            // 3. Mulai timer sesi
            startSessionTimer();

            // 4. Handle resize untuk navigasi
            window.addEventListener('resize', renderNavigation);

            // 5. Mencegah browser back button untuk navigasi internal (menggunakan hash)
            // Ini adalah cara paling sederhana untuk "menahan" navigasi internal tanpa mengganggu tombol back
            window.onpopstate = function(event) {
                // Jika pengguna menekan tombol kembali, muat ulang halaman saat ini (atau navigasi ke state yang terakhir)
                // Untuk kasus ini, kita hanya ingin mencegah mundur, jadi kita biarkan tetap di halaman saat ini dan ganti hash jika ada
                if (event.state && event.state.page) {
                    // Jika ada state yang tersimpan (misalnya dari pushState sebelumnya), gunakan itu
                    currentPage = event.state.page;
                    renderNavigation();
                    renderPage(currentPage);
                } else {
                    // Jika tidak ada state (klik tombol back yang benar-benar mundur), muat ulang untuk keamanan sesi
                    // window.location.reload(); 
                    // Lebih baik: paksa kembali ke Home jika URL diakses tanpa hash
                    changePage('Home');
                }
            };
            
            // Catatan: Permintaan "jangan halaman website mundur" diimplementasikan dengan:
            // a) Navigasi internal menggunakan fungsi JS (changePage) tanpa memodifikasi history.
            // b) Menggunakan onpopstate untuk menahan navigasi mundur (meskipun implementasi ini bisa kompleks).
            //    Solusi yang lebih sederhana adalah hanya menggunakan changePage dan membiarkan user kembali ke halaman sebelum load web app.

            showLoading(false);
            console.log("Aplikasi ASKAB PSSI Kepulauan Mentawai berhasil diinisialisasi.");
        };

        // Mulai aplikasi setelah DOM siap
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

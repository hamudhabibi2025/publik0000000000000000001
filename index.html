<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Mengatur font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styling untuk Navigasi Bawah */
        .nav-bar {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .active-nav-item {
            color: #1d4ed8; /* Blue-700 */
        }
        /* Style untuk Carousel */
        .carousel-item {
            width: 100%;
            flex-shrink: 0;
        }
        /* Memastikan track carousel bisa di-drag */
        #carousel-track {
            touch-action: pan-y; 
            cursor: grab;
        }
        #carousel-track:active {
             cursor: grabbing;
        }
        /* Animasi loading ringan */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex items-center justify-center hidden">
        <div class="spinner"></div>
        <p class="ml-3 text-lg font-medium text-gray-700">Memuat data...</p>
    </div>

    <!-- Main Content Container -->
    <div id="app-content" class="flex-grow pb-[60px] overflow-x-hidden">
        <!-- Konten halaman akan dirender di sini -->
    </div>

    <!-- Sticky Bottom Navigation Bar (Fixed for mobile and desktop) -->
    <nav id="nav-bar" class="nav-bar fixed bottom-0 left-0 right-0 h-14 bg-white z-50 flex justify-around items-center border-t border-gray-200">
        <!-- Nav items will be generated by JS -->
    </nav>

    <!-- Modal Container (Hidden by default) -->
    <div id="modal-container" class="modal fixed inset-0 z-[1000] bg-black bg-opacity-70 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <!-- Modal content will be injected here -->
    </div>

    <!-- Session Timeout Modal -->
    <div id="session-modal" class="modal fixed inset-0 z-[1001] bg-black bg-opacity-80 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-3">Sesi Berakhir</h3>
            <p class="text-gray-700 mb-6">Waktu melihat Anda telah habis (30 menit). Silakan muat ulang halaman untuk melanjutkan.</p>
            <button onclick="window.location.reload();" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">Muat Ulang Halaman</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // GANTI DENGAN URL WEB APP APPS SCRIPT ANDA SETELAH DI-DEPLOY!
        const API_URL = "https://script.google.com/macros/s/AKfycbzAuQ82x0a6hHkoLmWXOi6RK31Y5QXYZtIddHVQxG1292bNx6uqsFeBjN2SXSr1teEi/exec"; 
        const SESSION_DURATION_MS = 30 * 60 * 1000; // 30 menit
        const NEWS_SUMMARY_WORDS = 20; // 20 kata pertama untuk ringkasan berita

        // --- GLOBAL STATE ---
        let appData = {};
        let currentPage = 'Home';
        let sessionTimeout;
        let isDataLoaded = false;
        
        // Carousel State (Home Page Banner)
        let isDragging = false;
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let currentCarouselIndex = 0;
        let carouselInterval;
        let totalCarouselItems = 0;
        let carouselTrack;
        
        // Carousel State (Modal Image Slider)
        let modalCarouselIndex = 0;

        // --- UTILITY FUNCTIONS ---
        
        const formatDate = (dateInput) => {
            if (!dateInput) return '-';

            let date;
            // Coba parsing YYYY-MM-DD format dari Apps Script
            const parts = String(dateInput).split('-');
            if (parts.length === 3) {
                // Gunakan new Date(tahun, bulan-1, hari)
                date = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                date = new Date(dateInput);
            }

            if (isNaN(date.getTime())) return '-';
            
            const options = {
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            // Format penuh Indonesia: Hari, DD Bulan YYYY
            return date.toLocaleDateString('id-ID', options);
        };

        const truncateText = (text, maxWords) => {
            if (!text) return '';
            const words = text.split(/\s+/);
            if (words.length > maxWords) {
                return words.slice(0, maxWords).join(' ') + '...';
            }
            return text;
        };
        
        const fetchData = async (route, params = {}) => {
            const loadingElement = document.getElementById('loading');
            
            const loadingTimeout = setTimeout(() => {
                loadingElement.classList.remove('hidden');
            }, 100);

            try {
                if (API_URL === "GANTI DENGAN URL WEB APP APPS SCRIPT") {
                    throw new Error("API_URL belum diatur. Harap ganti placeholder dengan URL Web App Apps Script Anda.");
                }

                const url = new URL(API_URL);
                url.searchParams.set('route', route);
                for (const key in params) {
                    url.searchParams.set(key, params[key]);
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    return data.data;
                } else {
                    console.error('API Error:', data.message);
                    throw new Error(`Gagal dari server: ${data.message}`);
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                document.getElementById('app-content').innerHTML = `
                    <div class="p-8 text-center text-red-600 bg-red-100 m-4 rounded-xl">
                        <p class="font-bold mb-2">Gagal Memuat Data Awal!</p>
                        <p>Pastikan URL Web App Apps Script sudah di-deploy, diakses tanpa batasan, dan API_URL sudah benar.</p>
                        <p class="text-sm mt-2">Detail Error: ${error.message}</p>
                    </div>
                `;
                return null;
            } finally {
                clearTimeout(loadingTimeout);
                loadingElement.classList.add('hidden');
            }
        };

        // --- SESSION MANAGEMENT ---

        const startSessionTimer = () => {
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            sessionTimeout = setTimeout(() => {
                const sessionModal = document.getElementById('session-modal');
                sessionModal.classList.remove('opacity-0', 'pointer-events-none');
                sessionModal.classList.add('opacity-100');
            }, SESSION_DURATION_MS);
        };

        // --- RENDERING COMPONENTS ---

        const renderHeader = (title = 'ASKAB PSSI KEPULAUAN MENTAWAI') => {
            const headerData = appData.kepala_halaman || {};
            const logoPSSI = headerData.logo_pssi || 'https://placehold.co/50x50/3b82f6/ffffff?text=PSSI'; 
            const judulKepala = headerData.judul_kepala || 'ASKAB PSSI KEPULAUAN MENTAWAI';
            const logoASKAB = headerData.logo_askab || 'https://placehold.co/50x50/10b981/ffffff?text=ASKAB';

            return `
                <header class="sticky top-0 bg-white p-3 border-b border-gray-200 shadow-md z-40">
                    <div class="container mx-auto max-w-4xl flex items-center justify-between">
                        <img src="${logoPSSI}" alt="Logo PSSI" class="h-10 w-10 object-contain rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/50x50/3b82f6/ffffff?text=PSSI'" loading="lazy">
                        <h1 class="text-base sm:text-lg font-bold text-center text-gray-800 flex-grow mx-2 line-clamp-2">${judulKepala}</h1>
                        <img src="${logoASKAB}" alt="Logo ASKAB" class="h-10 w-10 object-contain rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/50x50/10b981/ffffff?text=ASKAB'" loading="lazy">
                    </div>
                </header>
            `;
        };

        const renderNavBar = () => {
            const navBar = document.getElementById('nav-bar');
            navBar.innerHTML = '';

            const navItems = [
                { name: 'Home', icon: 'Home' },
                { name: 'Kompetisi', icon: 'Trophy' },
                { name: 'Klub', icon: 'Shield' },
                { name: 'Tentang', icon: 'Info' }
            ];

            navItems.forEach(item => {
                const isActive = currentPage === item.name;
                const button = document.createElement('button');
                button.className = `flex flex-col items-center justify-center p-2 text-sm font-medium transition-colors duration-200 ${isActive ? 'text-blue-600 active-nav-item' : 'text-gray-500 hover:text-blue-600 hover:bg-gray-50'}`;
                button.setAttribute('data-page', item.name);
                button.innerHTML = `
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">${item.name}</span>
                `;
                button.onclick = () => navigate(item.name);
                navBar.appendChild(button);
                
                lucide.createIcons();
            });
        };

        const renderHome = () => {
            const newsData = appData.berita_home || [];
            const bannerData = appData.banner || [];
            
            // Sortir berita berdasarkan tanggal terbaru
            const sortedNews = newsData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let content = renderHeader('ASKAB PSSI KEPULAUAN MENTAWAI');
            content += `
                <div class="p-4 space-y-6 max-w-4xl mx-auto">
                    <!-- Kolom Pencarian Berita (Sticky) -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30 -mx-4 px-4">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="news-search" placeholder="Cari Berita (Judul/Isi)" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Home', this.value)">
                        </div>
                    </div>

                    <!-- Banner Slide (Carousel) -->
                    <h2 class="text-xl font-bold text-gray-800">Galeri Terbaru (Swipe/Drag)</h2>
                    <div class="relative overflow-hidden rounded-xl shadow-lg h-48 sm:h-64 bg-gray-200" id="banner-carousel">
                        <div class="flex h-full w-full" id="carousel-track" 
                            ontouchstart="startDrag(event)" 
                            ontouchmove="onDrag(event)" 
                            ontouchend="endDrag(event)"
                            onmousedown="startDrag(event)" 
                            onmousemove="onDrag(event)" 
                            onmouseup="endDrag(event)"
                            onmouseleave="endDrag(event)">
                            ${bannerData.map((item, index) => {
                                // Ambil gambar pertama yang valid dari 3 kolom
                                const imageUrl = item['poto-1'] || item['poto-2'] || item['poto-3'] || 'https://placehold.co/800x400/3b82f6/ffffff?text=BANNER';
                                return `
                                    <div class="carousel-item h-full">
                                        <img src="${imageUrl}" alt="Banner ${index + 1}" class="w-full h-full object-cover" 
                                            onerror="this.onerror=null;this.src='https://placehold.co/800x400/3b82f6/ffffff?text=BANNER'" loading="lazy">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${bannerData.length === 0 ? '<div class="absolute inset-0 flex items-center justify-center text-gray-500">Tidak ada gambar banner.</div>' : ''}
                    </div>

                    <!-- Ringkasan Berita -->
                    <h2 class="text-xl font-bold text-gray-800">Berita Terbaru</h2>
                    <div id="news-list" class="space-y-4">
                        ${sortedNews.map(item => renderNewsCard(item)).join('')}
                        ${sortedNews.length === 0 ? '<p class="text-center text-gray-500">Belum ada berita yang tersedia.</p>' : ''}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
            initCarousel(bannerData.length);
        };

        const renderNewsCard = (item) => {
            if (!item.Judul_Berita || !item.isi_berita) {
                return ''; 
            }
            
            const firstImage = item.gambar_1 || item.gambar_2 || item.gambar_3 || 'https://placehold.co/400x250/9ca3af/ffffff?text=NO+IMAGE';
            const summary = truncateText(item.isi_berita || '', NEWS_SUMMARY_WORDS);
            const date = formatDate(item.tanggal);

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden transition transform hover:scale-[1.01] cursor-pointer" onclick="showNewsModal('${item.id_berita}')">
                    <div class="flex flex-col sm:flex-row">
                        <!-- Gambar Berita -->
                        <div class="w-full sm:w-1/3 h-40 sm:h-auto overflow-hidden">
                            <img src="${firstImage}" alt="${item.Judul_Berita}" class="w-full h-full object-cover transition duration-300 hover:opacity-90" 
                                onerror="this.onerror=null;this.src='https://placehold.co/400x250/9ca3af/ffffff?text=NO+IMAGE'" loading="lazy">
                        </div>
                        
                        <!-- Konten Berita -->
                        <div class="w-full sm:w-2/3 p-4">
                            <p class="text-sm font-semibold text-blue-600 mb-1">${date}</p>
                            <h3 class="text-lg font-bold text-gray-800 mb-2 line-clamp-2">${item.Judul_Berita}</h3>
                            <p class="text-gray-600 text-sm line-clamp-3">${summary}</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- MODAL & SHARING ---
        
        const showNewsModal = async (id_berita) => {
            // Tampilkan loading di modal sebelum fetching
            document.getElementById('modal-container').innerHTML = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6 text-center">
                    <div class="spinner mx-auto mb-3"></div>
                    <p class="text-gray-700">Memuat detail berita...</p>
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                </div>
            `;
            showModal();
            
            const detail = await fetchData('getNewsDetails', { id: id_berita });
            if (!detail) {
                 hideModal();
                 showNotification('Gagal memuat detail berita.', 'error');
                 return;
            }

            const images = [detail.gambar_1, detail.gambar_2, detail.gambar_3].filter(url => url && url.startsWith('http'));
            const date = formatDate(detail.tanggal);

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl">
                    <!-- Close Button -->
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Detail Content -->
                    <div class="p-6">
                        <!-- Image Slider in Modal -->
                        ${images.length > 0 ? `
                            <div class="relative h-64 sm:h-96 overflow-hidden rounded-lg mb-4 bg-gray-100" id="modal-image-carousel">
                                <div class="flex transition-transform duration-500 ease-in-out h-full" id="modal-carousel-track">
                                    ${images.map((img, index) => `
                                        <div class="carousel-item h-full">
                                            <img src="${img}" alt="Gambar Berita ${index + 1}" class="w-full h-full object-contain" 
                                                onerror="this.onerror=null;this.src='https://placehold.co/800x400/9ca3af/ffffff?text=GAMBAR+TIDAK+DITEMUKAN'" loading="lazy">
                                        </div>
                                    `).join('')}
                                </div>
                                ${images.length > 1 ? `
                                    <button class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70" onclick="changeModalSlide(-1)">
                                        <i data-lucide="ChevronLeft" class="w-6 h-6"></i>
                                    </button>
                                    <button class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70" onclick="changeModalSlide(1)">
                                        <i data-lucide="ChevronRight" class="w-6 h-6"></i>
                                    </button>
                                ` : ''}
                            </div>
                        ` : '<div class="h-4"></div>'}

                        <p class="text-sm font-medium text-gray-500 mb-1">${date}</p>
                        <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-4">${detail.Judul_Berita}</h2>
                        <!-- Mengganti newline ke <br> untuk tampilan teks yang sesuai dari spreadsheet -->
                        <div class="text-gray-700 leading-relaxed">${detail.isi_berita ? detail.isi_berita.replace(/\n/g, '<br>') : 'Konten berita tidak tersedia.'}</div>
                        
                        <!-- Share Button -->
                        <div class="mt-6 border-t pt-4 flex justify-end">
                            <button onclick="shareNews('${detail.id_berita}')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition">
                                <i data-lucide="Share2" class="w-5 h-5 mr-2"></i> Bagikan Link Berita
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalContent;
            lucide.createIcons();

             // Logic untuk modal image slider
            const modalTrack = document.getElementById('modal-carousel-track');
            if (modalTrack) {
                modalCarouselIndex = 0;
                // Set initial state for modal slider
                modalTrack.style.transition = 'transform 0.5s ease-in-out';
                modalTrack.style.transform = `translateX(0)`;
            }
        };

        const showModal = () => {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('pointer-events-none');
            modal.classList.add('opacity-100');
        }

        const hideModal = () => {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => { modal.innerHTML = ''; }, 300); 
        }

        const shareNews = (id_berita) => {
            // Membuat link yang mengarahkan ke halaman Home dan menyalinnya
            const newsLink = `${window.location.origin}${window.location.pathname}#home`; 
            
            const el = document.createElement('textarea');
            el.value = newsLink;
            document.body.appendChild(el);
            el.select();
            try {
                // Menggunakan document.execCommand('copy') untuk kompatibilitas iframe
                const successful = document.execCommand('copy');
                const msg = successful ? 'Link Berhasil Disalin!' : 'Gagal menyalin link.';
                showNotification(msg, successful ? 'success' : 'error');
            } catch (err) {
                showNotification('Gagal menyalin link. Silakan salin manual.', 'error');
            }
            document.body.removeChild(el);
        }

        let notificationTimeout;
        const showNotification = (message, type = 'info') => {
            let notification = document.getElementById('notification-box');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification-box';
                document.body.appendChild(notification);
            }

            let bgColor = 'bg-blue-600';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';
            
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-[1010] transition-opacity duration-300 opacity-0 text-white font-medium ${bgColor}`;
            notification.textContent = message;

            // Show
            notification.classList.remove('opacity-0');
            notification.classList.add('opacity-100');

            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                // Hide
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 5000); 
        }

        // --- CAROUSEL LOGIC ---
        
        const initCarousel = (totalItems) => {
            carouselTrack = document.getElementById('carousel-track');
            totalCarouselItems = totalItems;
            
            if (!carouselTrack || totalItems < 2) {
                if (carouselInterval) clearInterval(carouselInterval);
                return;
            }

            // Reset drag state
            isDragging = false;
            currentTranslate = 0;
            prevTranslate = 0;
            currentCarouselIndex = 0;
            carouselTrack.style.transition = 'none';
            setSliderPosition();

            // Auto-slide logic
            if (carouselInterval) clearInterval(carouselInterval);
            carouselInterval = setInterval(() => {
                currentCarouselIndex = (currentCarouselIndex + 1) % totalItems;
                currentTranslate = currentCarouselIndex * -carouselTrack.clientWidth;
                prevTranslate = currentTranslate;
                carouselTrack.style.transition = 'transform 0.5s ease-in-out';
                setSliderPosition();
            }, 3000); // Bergerak setiap 3 detik
        };
        
        const startDrag = (event) => {
            if (totalCarouselItems <= 1) return;
            if (event.target.closest('#modal-container')) return; 

            if (event.type.includes('touch')) {
                startX = event.touches[0].clientX;
            } else { // mousedown
                startX = event.clientX;
                document.body.style.cursor = 'grabbing';
            }
            isDragging = true;
            carouselTrack.style.transition = 'none';
            if (carouselInterval) clearInterval(carouselInterval);
            
            animationID = requestAnimationFrame(animation);
        };

        const onDrag = (event) => {
            if (!isDragging) return;

            let currentX;
            if (event.type.includes('touch')) {
                currentX = event.touches[0].clientX;
            } else { // mousemove
                currentX = event.clientX;
            }
            
            const distance = currentX - startX;
            currentTranslate = prevTranslate + distance;
        };

        const endDrag = (event) => {
            if (!isDragging) return;

            isDragging = false;
            cancelAnimationFrame(animationID);
            
            const movedBy = currentTranslate - prevTranslate;

            // Threshold: 20% width
            if (movedBy < -carouselTrack.clientWidth / 5 && currentCarouselIndex < totalCarouselItems - 1) {
                currentCarouselIndex++;
            } else if (movedBy > carouselTrack.clientWidth / 5 && currentCarouselIndex > 0) {
                currentCarouselIndex--;
            }
            
            currentTranslate = currentCarouselIndex * -carouselTrack.clientWidth;
            prevTranslate = currentTranslate;
            
            carouselTrack.style.transition = 'transform 0.3s ease-in-out';
            setSliderPosition();
            
            // Restart auto-slide
            initCarousel(totalCarouselItems);
            
            document.body.style.cursor = 'default';
        };

        const animation = () => {
            setSliderPosition();
            if (isDragging) requestAnimationFrame(animation);
        };

        const setSliderPosition = () => {
            carouselTrack.style.transform = `translateX(${currentTranslate}px)`;
        };
        
        const changeModalSlide = (direction) => {
            const track = document.getElementById('modal-carousel-track');
            if (!track) return;

            const totalItems = track.children.length;
            
            modalCarouselIndex = (modalCarouselIndex + direction + totalItems) % totalItems;
            // Setiap item carousel modal memiliki lebar 100%
            track.style.transform = `translateX(-${modalCarouselIndex * 100}%)`; 
        };
        
        // --- RENDERING KOMPETISI PAGE ---

        const renderKompetisi = () => {
            const competitions = appData.kompetisi || [];

            let content = renderHeader('Kompetisi');
            content += `
                <div class="p-4 space-y-6 max-w-4xl mx-auto">
                    <!-- Kolom Pencarian Kompetisi (Sticky) -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30 -mx-4 px-4">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="competition-search" placeholder="Cari Nama Kompetisi atau Nama Klub" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Kompetisi', this.value)">
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800">Daftar Kompetisi</h2>
                    <!-- Grid Ringkasan Kompetisi (Nama Kompetisi Saja) -->
                    <div id="competition-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        ${renderCompetitionGrid(competitions)}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderCompetitionGrid = (competitions) => {
            // Mendapatkan daftar nama kompetisi unik dari hasil filter
            const uniqueCompetitionNames = [...new Set(competitions
                .map(c => c.nama_kompetisi)
                .filter(name => name)
                .map(name => String(name).trim()))
            ]; 

            if (uniqueCompetitionNames.length === 0) {
                return '<p class="col-span-2 sm:col-span-3 text-center text-gray-500 p-8">Tidak ada data kompetisi yang ditemukan.</p>';
            }

            return uniqueCompetitionNames.map(name => `
                <div class="bg-white rounded-xl shadow-md p-4 flex items-center justify-center text-center h-24 sm:h-32 cursor-pointer transition hover:bg-blue-100 hover:shadow-lg"
                    onclick="showCompetitionListModal('${name.replace(/'/g, "\\'")}')">
                    <span class="text-base sm:text-lg font-semibold text-gray-800 line-clamp-2">${name}</span>
                </div>
            `).join('');
        };

        const showCompetitionListModal = (competitionName) => {
            const allCompetitions = appData.kompetisi || [];
            const filteredCompetitions = allCompetitions.filter(c => c.nama_kompetisi === competitionName);
            
            // Urutkan berdasarkan tanggal terbaru
            const sortedCompetitions = filteredCompetitions.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6">
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">${competitionName}</h2>
                    <div class="space-y-4">
                        ${sortedCompetitions.map(item => renderCompetitionCard(item)).join('')}
                    </div>
                    ${sortedCompetitions.length === 0 ? '<p class="text-center text-gray-500">Tidak ada detail pertandingan untuk kompetisi ini.</p>' : ''}
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalContent;
            showModal();
            lucide.createIcons();
        };

        const renderCompetitionCard = (item) => {
            const date = formatDate(item.tanggal);
            const jenis = item.jenis_pertandingan || 'Pertandingan';
            const lokasi = item.lokasi || 'Tidak diketahui';
            const club1Name = item.nama_klub1 || 'Klub 1';
            const club2Name = item.nama_klub2 || 'Klub 2';

            return `
                <div class="bg-gray-50 rounded-xl p-4 shadow-md border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 border-b pb-2">
                        <span class="text-sm font-semibold text-blue-600">${item.nama_kompetisi || 'Kompetisi Tidak Diketahui'} (${jenis})</span>
                        <span class="text-sm text-gray-500 mt-1 sm:mt-0"><i data-lucide="Calendar" class="w-4 h-4 inline-block align-text-bottom"></i> ${date}</span>
                    </div>
                    
                    <!-- Skor dan Logo -->
                    <div class="flex items-center justify-between text-center space-x-2">
                        <!-- Klub 1 -->
                        <div class="flex-1 space-y-1">
                            <img src="${item.logo_klub1 || 'https://placehold.co/60x60/f87171/ffffff?text=K1'}" alt="${club1Name}" class="w-12 h-12 sm:w-16 sm:h-16 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/60x60/f87171/ffffff?text=K1'" loading="lazy">
                            <p class="font-bold text-gray-800 text-sm sm:text-base line-clamp-1">${club1Name}</p>
                            <p class="text-3xl font-extrabold text-red-600">${item.goal1 !== null && item.goal1 !== '' ? item.goal1 : '?'}</p>
                        </div>
                        
                        <span class="text-lg font-bold text-gray-600">VS</span>

                        <!-- Klub 2 -->
                        <div class="flex-1 space-y-1">
                            <img src="${item.logo_klub2 || 'https://placehold.co/60x60/22c55e/ffffff?text=K2'}" alt="${club2Name}" class="w-12 h-12 sm:w-16 sm:h-16 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/60x60/22c55e/ffffff?text=K2'" loading="lazy">
                            <p class="font-bold text-gray-800 text-sm sm:text-base line-clamp-1">${club2Name}</p>
                            <p class="text-3xl font-extrabold text-red-600">${item.goal2 !== null && item.goal2 !== '' ? item.goal2 : '?'}</p>
                        </div>
                    </div>
                    
                    <!-- Lokasi -->
                    <div class="text-center mt-3 pt-2 border-t border-gray-200 text-sm text-gray-600">
                        <i data-lucide="MapPin" class="w-4 h-4 inline-block align-text-bottom"></i> Lokasi: ${lokasi}
                    </div>

                    <!-- Detail Statistik -->
                    <div class="mt-4 pt-3 border-t border-gray-300 text-sm">
                        <h4 class="font-semibold text-gray-800 mb-2 border-b pb-1">Detail Statistik Pertandingan:</h4>
                        
                        <!-- Header Kolom -->
                        <div class="grid grid-cols-5 text-xs font-semibold text-gray-600 mb-1 border-b pb-1">
                            <div class="col-span-2 text-left">${club1Name}</div>
                            <div class="text-center">Kategori</div>
                            <div class="col-span-2 text-right">${club2Name}</div>
                        </div>

                        <!-- Data Baris -->
                        ${renderStatsRow(item.goal1 || 0, 'Gol', item.goal2 || 0, item.Ket_goal1, item.Ket_goal2, 'Target')}
                        ${renderStatsRow(item.kartu_kuning1 || 0, 'Kartu Kuning', item.kartu_kuning2 || 0, item.ket_kartu_kuning1, item.ket_kartu_kuning2, 'Square', 'text-yellow-500')}
                        ${renderStatsRow(item.kartu_merah1 || 0, 'Kartu Merah', item.kartu_merah2 || 0, item.ket_kartu_merah1, item.ket_kartu_merah2, 'Square', 'text-red-700 fill-red-700')}
                    </div>
                </div>
            `;
        };
        
        // Fungsi pembantu untuk merender satu baris statistik
        const renderStatsRow = (val1, label, val2, ket1, ket2, iconName, iconClass = 'text-gray-500') => {
            return `
                <div class="grid grid-cols-5 py-1 items-start border-b border-gray-100 last:border-b-0">
                    <!-- Value 1 & Keterangan -->
                    <div class="col-span-2 text-left pr-2">
                        <span class="font-bold">${val1}</span>
                        <p class="text-xs text-gray-500">${ket1 || '-'}</p>
                    </div>
                    
                    <!-- Label & Icon -->
                    <div class="col-span-1 text-center font-medium text-gray-700">
                        <i data-lucide="${iconName}" class="w-4 h-4 inline-block align-text-bottom mr-1 ${iconClass}"></i>
                        <span class="hidden sm:inline">${label.split(' ')[0]}</span>
                        <span class="inline sm:hidden">${label.split(' ')[0][0]}</span>
                    </div>

                    <!-- Value 2 & Keterangan -->
                    <div class="col-span-2 text-right pl-2">
                        <span class="font-bold">${val2}</span>
                        <p class="text-xs text-gray-500">${ket2 || '-'}</p>
                    </div>
                </div>
            `;
        };

        // --- RENDERING KLUB PAGE ---

        const renderKlub = () => {
            const clubs = appData.klub || [];

            let content = renderHeader('Klub Anggota');
            content += `
                <div class="p-4 space-y-6 max-w-4xl mx-auto">
                    <!-- Kolom Pencarian Klub (Sticky) -->
                    <div class="sticky top-[58px] bg-white pt-2 pb-3 border-b border-gray-200 z-30 -mx-4 px-4">
                        <div class="relative">
                            <i data-lucide="Search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="club-search" placeholder="Cari Nama Klub/Julukan" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition"
                                onkeyup="filterContent('Klub', this.value)">
                        </div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-800">Daftar Klub Anggota</h2>
                    <!-- Grid Ringkasan Klub -->
                    <div id="club-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        ${renderClubGrid(clubs)}
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderClubGrid = (clubs) => {
            const filteredClubs = clubs.filter(club => club.nama_klub);
            
            if (filteredClubs.length === 0) {
                return '<p class="col-span-2 sm:col-span-4 text-center text-gray-500 p-8">Tidak ada data klub anggota.</p>';
            }

            return filteredClubs.map(club => `
                <div class="bg-white rounded-xl shadow-md p-4 text-center cursor-pointer transition hover:bg-green-100 hover:shadow-lg"
                    onclick="showClubDetailModal('${club.nama_klub.replace(/'/g, "\\'")}')">
                    <img src="${club.logo_klub || 'https://placehold.co/80x80/10b981/ffffff?text=LOGO'}" alt="${club.nama_klub}" class="w-16 h-16 object-contain mx-auto mb-2 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/80x80/10b981/ffffff?text=LOGO'" loading="lazy">
                    <p class="font-bold text-gray-800 text-sm line-clamp-1">${club.nama_klub}</p>
                    <p class="text-xs text-gray-500 line-clamp-1">"${club.julukan || '-'}"</p>
                </div>
            `).join('');
        };

        const showClubDetailModal = async (clubName) => {
            const club = (appData.klub || []).find(c => c.nama_klub === clubName);
            if (!club) return;
            
            // Tampilkan modal loading awal
            document.getElementById('modal-container').innerHTML = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6 text-center">
                    <div class="spinner mx-auto mb-3"></div>
                    <p class="text-gray-700">Memuat riwayat pertandingan untuk ${clubName}...</p>
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                </div>
            `;
            showModal();

            // PANGGIL FUNGSI APPS SCRIPT untuk riwayat kompetisi
            const competitions = await fetchData('getCompetitionsByClub', { clubName: clubName });
            
            const sortedCompetitions = (competitions || []).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            let modalContent = `
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative shadow-2xl p-6">
                    <button class="absolute top-4 right-4 bg-red-600 text-white rounded-full p-2 z-50 hover:bg-red-700" onclick="hideModal()">
                        <i data-lucide="X" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Club Profile Header -->
                    <div class="flex flex-col sm:flex-row items-center sm:items-start border-b pb-4 mb-4">
                        <img src="${club.logo_klub || 'https://placehold.co/100x100/10b981/ffffff?text=LOGO'}" alt="${club.nama_klub}" class="w-24 h-24 object-contain rounded-full mb-3 sm:mb-0 sm:mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/10b981/ffffff?text=LOGO'">
                        <div class="text-center sm:text-left">
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">${club.nama_klub}</h2>
                            <p class="text-lg font-semibold text-green-600">"${club.julukan || '-'}"</p>
                            <p class="text-sm text-gray-500">Berdiri sejak: ${formatDate(club.tanggal_berdiri) || '-'} | Alamat: ${club.alamat || '-'}</p>
                        </div>
                    </div>
                    
                    <!-- Detail Manajemen -->
                    <h3 class="text-xl font-bold text-gray-800 mb-3 mt-6">Manajemen & Staf</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-700 mb-6 border-b pb-4">
                        <p><span class="font-semibold">Manajer:</span> ${club.manejer || '-'}</p>
                        <p><span class="font-semibold">Asisten Manajer:</span> ${club.asisten_manejer || '-'}</p>
                        <p><span class="font-semibold">Pelatih Kepala:</span> ${club.pelatih || '-'}</p>
                        <p><span class="font-semibold">Asisten Pelatih:</span> ${club.asisten_pelatih || '-'}</p>
                        <p><span class="font-semibold">Staff Lainnya:</span> ${club.staff_lainnya || '-'}</p>
                        <p><span class="font-semibold">No. HP Klub:</span> ${club.no_handphone_klub || '-'}</p>
                    </div>

                    <!-- Riwayat Kompetisi Klub -->
                    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-4">Riwayat Pertandingan Terakhir</h3>
                    <div class="space-y-4">
                        ${sortedCompetitions.map(item => renderCompetitionCard(item)).join('')}
                    </div>
                    ${sortedCompetitions.length === 0 ? `<p class="text-center text-gray-500 p-4">Klub ${clubName} belum memiliki riwayat pertandingan.</p>` : ''}
                </div>
            `;

            document.getElementById('modal-container').innerHTML = modalContent;
            lucide.createIcons();
        };


        // --- RENDERING TENTANG PAGE ---

        const renderTentang = () => {
            const profil = appData.profil || {};
            const struktur = appData.struktur_organisasi || {};
            
            let content = renderHeader('Tentang Kami');
            content += `
                <div class="p-4 space-y-8 max-w-4xl mx-auto">
                    
                    <!-- Profil Organisasi -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                        <h2 class="text-2xl font-extrabold text-blue-600 mb-4">${profil.nama_organisasi || 'ASKAB PSSI KEPULAUAN MENTAWAI'}</h2>
                        <p class="text-sm text-gray-500 mb-4">Didirikan sejak: ${formatDate(profil.tanggal_berdiri) || '-'}</p>
                        
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-1 mb-2 flex items-center"><i data-lucide="Eye" class="w-5 h-5 mr-2 text-red-500"></i> Visi</h3>
                                <p class="text-gray-700 whitespace-pre-wrap">${profil.visi || 'Visi belum diisi.'}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-1 mb-2 flex items-center"><i data-lucide="Target" class="w-5 h-5 mr-2 text-green-500"></i> Misi</h3>
                                <p class="text-gray-700 whitespace-pre-wrap">${profil.misi || 'Misi belum diisi.'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Struktur Organisasi -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-600">
                        <h2 class="text-2xl font-extrabold text-green-600 mb-4 flex items-center"><i data-lucide="Users" class="w-6 h-6 mr-2"></i> Struktur Pengurus Inti</h2>
                        
                        <div class="space-y-2">
                            ${renderStructureItem('Ketua Umum', struktur.ketua)}
                            ${renderStructureItem('Wakil Ketua', struktur.wakil_ketua)}
                            ${renderStructureItem('Sekretaris', struktur.sekretaris)}
                            ${renderStructureItem('Bendahara', struktur.bendahara)}
                            ${renderStructureItem('Humas', struktur.humas)}
                            ${renderStructureItem('Media', struktur.media)}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = content;
            lucide.createIcons();
        };

        const renderStructureItem = (role, name) => {
            if (!name) return '';
            return `
                <div class="flex justify-between items-center border-b pb-2">
                    <span class="font-semibold text-gray-700">${role}:</span>
                    <span class="text-base font-medium text-gray-900">${name}</span>
                </div>
            `;
        }

        // --- FILTERING LOGIC (Search) ---
        
        const filterContent = (page, query) => {
            const normalizedQuery = query.toLowerCase().trim();
            const contentContainer = document.getElementById(page === 'Home' ? 'news-list' : page === 'Kompetisi' ? 'competition-grid' : 'club-grid');
            let htmlContent = '';

            if (!contentContainer) return;

            if (page === 'Home') {
                const newsData = appData.berita_home || [];
                const filteredItems = newsData.filter(item => 
                    (item.Judul_Berita && item.Judul_Berita.toLowerCase().includes(normalizedQuery)) ||
                    (item.isi_berita && item.isi_berita.toLowerCase().includes(normalizedQuery))
                );
                // Sortir ulang hasil filter
                filteredItems.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                htmlContent = filteredItems.map(item => renderNewsCard(item)).join('');
                
            } else if (page === 'Kompetisi') {
                const competitions = appData.kompetisi || [];
                const filteredCompetitions = competitions.filter(item => 
                    (item.nama_kompetisi && String(item.nama_kompetisi).toLowerCase().includes(normalizedQuery)) ||
                    (item.nama_klub1 && String(item.nama_klub1).toLowerCase().includes(normalizedQuery)) ||
                    (item.nama_klub2 && String(item.nama_klub2).toLowerCase().includes(normalizedQuery))
                );
                htmlContent = renderCompetitionGrid(filteredCompetitions);
            } else if (page === 'Klub') {
                const clubs = appData.klub || [];
                const filteredItems = clubs.filter(item => 
                    (item.nama_klub && String(item.nama_klub).toLowerCase().includes(normalizedQuery)) ||
                    (item.julukan && String(item.julukan).toLowerCase().includes(normalizedQuery))
                );
                htmlContent = renderClubGrid(filteredItems);
            }
            
            if (htmlContent.trim() === '') {
                htmlContent = `<p class="col-span-full text-center text-gray-500 p-8">Tidak ada hasil yang relevan untuk "${query}".</p>`;
            }

            contentContainer.innerHTML = htmlContent;
            lucide.createIcons();
        };


        // --- NAVIGATION & ROUTING ---

        const navigate = (pageName, skipHistory = false) => {
            if (!isDataLoaded) return; 
            if (currentPage === pageName) return; 

            // Clear auto-slide interval saat pindah halaman
            if (carouselInterval) clearInterval(carouselInterval);
            
            currentPage = pageName;
            
            const newHash = `#${pageName.toLowerCase().replace(/\s+/g, '-')}`;
            if (!skipHistory && window.location.hash !== newHash) {
                 window.history.pushState({ page: pageName }, pageName, newHash);
            }
            
            renderPage();
            renderNavBar();
            window.scrollTo(0, 0); 
        };

        const renderPage = () => {
            if (!isDataLoaded) return;

            switch (currentPage) {
                case 'Kompetisi':
                    renderKompetisi();
                    break;
                case 'Klub':
                    renderKlub();
                    break;
                case 'Tentang':
                    renderTentang();
                    break;
                case 'Home':
                default:
                    renderHome();
                    break;
            }
        };

        // --- INITIALIZATION ---

        const getPageFromHash = (hash) => {
             const routeMap = {
                'home': 'Home',
                'kompetisi': 'Kompetisi',
                'klub': 'Klub',
                'tentang': 'Tentang'
            };
            const normalizedHash = hash.slice(1).toLowerCase().replace(/-/g, ' ');
            return routeMap[normalizedHash] || 'Home';
        }

        const initializeApp = async () => {
            // Tentukan halaman awal sebelum data dimuat
            currentPage = getPageFromHash(window.location.hash);
            renderPage(); // Render dengan data kosong/loading state
            renderNavBar();
            
            startSessionTimer();

            const data = await fetchData('getInitialData');
            
            if (data) {
                appData = data;
                isDataLoaded = true;
                
                // Render ulang dengan data yang dimuat
                currentPage = getPageFromHash(window.location.hash);
                renderPage(); 
                renderNavBar();
                
                // Pastikan hash di URL sesuai dengan halaman yang dimuat, tapi jangan push history baru
                const expectedHash = `#${currentPage.toLowerCase()}`;
                if (window.location.hash !== expectedHash) {
                    window.history.replaceState({ page: currentPage }, currentPage, expectedHash);
                }
            } else {
                // Biarkan pesan error di fetchData tetap terlihat
            }

        };

        // --- History API Listener (Mengatasi tombol back) ---
        window.addEventListener('popstate', (event) => {
            if (!isDataLoaded) return;

            // Navigasi ke halaman yang tersimpan di state atau berdasarkan hash
            const page = event.state && event.state.page ? event.state.page : getPageFromHash(window.location.hash);
            
            if (page !== currentPage) {
                 navigate(page, true); // True to skip pushing a new state
            }
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
        
    </script>
</body>
</html>

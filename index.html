<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASKAB PSSI KEPULAUAN MENTAWAI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Mengatur font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styling untuk Navigasi Bawah */
        .nav-bar {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .active-nav-item {
            color: #1d4ed8; /* Blue-700 */
        }
        /* Style untuk Carousel */
        .carousel-item {
            width: 100%;
            flex-shrink: 0;
        }
        /* Mengatur padding atas agar konten tidak tertutup fixed header (jika ada) */
        #app-container {
            padding-bottom: 72px; /* Setidaknya tinggi navbar + margin */
        }

        /* Utility classes for icon sizing via Lucide */
        .icon-lg { width: 32px; height: 32px; }
        .icon-md { width: 24px; height: 24px; }
        .icon-sm { width: 20px; height: 20px; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header (Optional, bisa dihilangkan jika fokus pada mobile app feel) -->
    <header class="bg-blue-600 p-4 text-white shadow-lg fixed top-0 left-0 right-0 z-10 max-w-xl mx-auto md:hidden">
        <h1 class="text-xl font-bold text-center">ASKAB PSSI MENTAWAI</h1>
    </header>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="max-w-xl mx-auto bg-white min-h-screen pt-4 md:pt-0">
        <!-- Konten Halaman akan dirender di sini -->
        <div id="page-content" class="p-4 pt-16 md:pt-4">
            <!-- Loading State -->
            <div id="loading-state" class="text-center p-8">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Memuat data dari Google Sheets...</p>
                <p class="text-xs text-red-500 mt-2">Pastikan Anda telah menyebarkan (Deploy) Apps Script sebagai Web App terbaru dan URL-nya sudah benar.</p>
            </div>
        </div>
    </div>

    <!-- Navigasi Bawah Tetap (Fixed Bottom Navigation) -->
    <nav id="nav-bar" class="nav-bar fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-20 max-w-xl mx-auto">
        <!-- Konten Nav Bar akan dirender oleh JavaScript -->
    </nav>

    <script>
        // --- KONFIGURASI APLIKASI ---
        // Ganti dengan URL Web App Apps Script Anda yang sudah di-deploy
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmAJSRJ20QKUr54Ake_dUzlEsLo5cfGlItCiuVM6RmUJv6HAuhPTA6alslbHGKq_XY/exec'; // GANTI INI!
        if (API_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
            console.error("!!! PERINGATAN: API_URL belum diganti. Pastikan Anda menggantinya dengan URL Web App Apps Script yang valid. !!!");
        }

        let appData = {
            news: [],
            competitions: [],
            clubs: []
        };
        let isDataLoaded = false;
        let currentPage = 'Beranda';
        let detailItemId = null; // Digunakan untuk menyimpan ID berita atau klub yang sedang dilihat

        const PAGES = ['Beranda', 'Berita', 'Kompetisi', 'Klub'];
        const ICON_MAP = {
            'Beranda': 'Home',
            'Berita': 'Newspaper',
            'Kompetisi': 'Trophy',
            'Klub': 'Shield'
        };
        const CLUB_DETAIL_PAGE = 'DetailKlub';
        const NEWS_DETAIL_PAGE = 'DetailBerita';


        // --- FUNGSI UTILITY ---

        /**
         * Mengubah URL gambar pihak ketiga (seperti ImgBB) menjadi URL proxy melalui Apps Script.
         * Ini akan memaksa gambar muncul dengan mem-bypass Referer Policy/CORS.
         * @param {string} originalUrl URL gambar asli dari Google Sheet.
         * @returns {string} URL baru yang mengarah ke Apps Script Image Proxy.
         */
        function getProxyImageUrl(originalUrl) {
            // Placeholder default jika URL kosong
            const placeholderUrl = 'https://placehold.co/400x200/cccccc/333333?text=Gambar+Tidak+Tersedia';

            if (!originalUrl || originalUrl.trim() === '' || API_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                return placeholderUrl;
            }
            
            // Encode URL asli agar bisa dilewatkan sebagai parameter
            const encodedUrl = encodeURIComponent(originalUrl);
            
            // Kembalikan URL proxy Apps Script
            // Format: API_URL?route=imageProxy&url=...
            return `${API_URL}?route=imageProxy&url=${encodedUrl}`;
        }
        

        /**
         * Mengambil data dari Apps Script Web App.
         * @param {string} route Nama route yang dipanggil.
         * @param {Object} params Parameter query tambahan.
         * @returns {Promise<Object|null>} Data hasil fetch atau null jika gagal.
         */
        async function fetchData(route, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('route', route);
            for (const key in params) {
                if (params[key] !== null && params[key] !== undefined) {
                    url.searchParams.append(key, params[key]);
                }
            }

            const loadingState = document.getElementById('loading-state');
            if (loadingState) {
                // Tampilkan loading hanya saat fetch baru (bukan inisialisasi awal)
                if (route !== 'getInitialData') {
                    loadingState.innerHTML = '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div><p class="text-gray-600">Memuat data...</p>';
                    loadingState.classList.remove('hidden');
                } else {
                     // Sembunyikan konten lama saat loading data awal
                    const pageContent = document.getElementById('page-content');
                    if(pageContent) pageContent.innerHTML = '';
                    if(loadingState) loadingState.classList.remove('hidden');
                }
            }


            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    return result.data;
                } else {
                    console.error('API Error:', result.message);
                    alertMessage(`Gagal memuat data: ${result.message}`, 'error');
                    return null;
                }

            } catch (error) {
                console.error('Fetch error:', error);
                alertMessage(`Terjadi kesalahan jaringan: ${error.message}`, 'error');
                return null;
            } finally {
                if (loadingState && route !== 'getInitialData') {
                    loadingState.classList.add('hidden');
                }
            }
        }

        /**
         * Menampilkan pesan notifikasi kustom (pengganti alert()).
         * @param {string} message Pesan yang akan ditampilkan.
         * @param {string} type Tipe pesan ('success' atau 'error').
         */
        function alertMessage(message, type = 'info') {
            const container = document.getElementById('app-container');
            if (!container) return; 

            // Buat div alert yang posisinya fixed di atas
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 left-1/2 -translate-x-1/2 max-w-sm w-11/12 p-4 rounded-lg text-sm transition-all duration-500 ease-out transform z-50 ${type === 'error' ? 'bg-red-100 text-red-700 border border-red-200 shadow-xl' : 'bg-green-100 text-green-700 border border-green-200 shadow-xl'}`;
            alertDiv.innerHTML = `<strong>${type === 'error' ? 'Error!' : 'Info:'}</strong> ${message}`;
            
            container.appendChild(alertDiv);
            
            // Hilangkan setelah 5 detik
            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => alertDiv.remove(), 500);
            }, 5000);
        }

        /**
         * Mendapatkan nama halaman dari hash URL.
         * @param {string} hash Hash dari window.location.hash.
         * @returns {string} Nama halaman yang sesuai.
         */
        function getPageFromHash(hash) {
            if (!hash || hash === '#') return 'Beranda';
            const page = hash.substring(1); // Hapus '#'
            const pageName = page.charAt(0).toUpperCase() + page.slice(1);

            // Cek apakah itu halaman detail atau halaman utama
            if (pageName.startsWith('DetailKlub-')) {
                 detailItemId = pageName.substring(11).replace(/_/g, ' '); // Ambil nama klub, kembalikan spasi
                 return CLUB_DETAIL_PAGE;
            } else if (pageName.startsWith('DetailBerita-')) {
                 detailItemId = parseInt(pageName.substring(13)); // Ambil ID berita
                 return NEWS_DETAIL_PAGE;
            } else if (PAGES.includes(pageName)) {
                detailItemId = null;
                return pageName;
            }
            return 'Beranda'; // Default jika hash tidak valid
        }

        /**
         * Mengubah rute halaman.
         * @param {string} page Nama halaman tujuan.
         * @param {boolean} skipPushState Jika true, hanya ganti state, tidak tambah ke history.
         */
        function navigate(page, skipPushState = false) {
            let hash = `#${page.toLowerCase()}`;
            currentPage = page;
            
            // Logika detailItemId diatur di getPageFromHash/navigateToDetail
            if (page === 'Beranda' || page === 'Berita' || page === 'Kompetisi' || page === 'Klub') {
                detailItemId = null;
            }

            if (!skipPushState) {
                window.history.pushState({ page: page }, page, hash);
            }

            renderPage();
            renderNavBar();
        }

        /**
         * Menavigasi ke halaman detail.
         * @param {string} page Nama halaman detail (DetailBerita atau DetailKlub).
         * @param {*} id ID atau Nama untuk detail.
         */
        function navigateToDetail(page, id) {
            detailItemId = id;
            currentPage = page;

            let hash = `#${page.toLowerCase()}`;

            if (page === NEWS_DETAIL_PAGE) {
                hash = `#${page.toLowerCase()}-${id}`;
            } else if (page === CLUB_DETAIL_PAGE) {
                // Gunakan format slug (huruf kecil, ganti spasi dengan underscore)
                hash = `#${page.toLowerCase()}-${id.toLowerCase().replace(/\s/g, '_')}`;
            }

            window.history.pushState({ page: page }, page, hash);
            renderPage();
            renderNavBar();
        }

        // --- FUNGSI RENDER KOMPONEN ---

        /**
         * Merender item navigasi di Nav Bar.
         * @param {string} page Nama halaman.
         * @returns {string} HTML untuk item navigasi.
         */
        function renderNavItem(page) {
            // Aktifkan Beranda untuk semua halaman detail Berita/Klub
            const isActive = currentPage === page || (page === 'Beranda' && (currentPage === NEWS_DETAIL_PAGE || currentPage === CLUB_DETAIL_PAGE));
            const iconName = ICON_MAP[page] || 'Home';
            const activeClass = isActive ? 'active-nav-item' : 'text-gray-500';

            return `
                <button onclick="navigate('${page}')" class="flex-1 flex flex-col items-center justify-center p-2 text-xs font-medium rounded-lg transition-colors hover:bg-gray-100 ${activeClass}">
                    <i data-lucide="${iconName}" class="icon-sm"></i>
                    <span class="mt-1">${page}</span>
                </button>
            `;
        }

        /**
         * Merender Navigasi Bar bawah.
         */
        function renderNavBar() {
            const navBar = document.getElementById('nav-bar');
            // Hanya tampilkan tombol Klub di Nav Bar jika tidak sedang di halaman detail Klub
            const showClubNav = currentPage !== CLUB_DETAIL_PAGE;

            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16 px-2">
                    ${renderNavItem('Beranda')}
                    ${renderNavItem('Berita')}
                    ${renderNavItem('Kompetisi')}
                    ${showClubNav ? renderNavItem('Klub') : ''}
                </div>
            `;
            // Menginisialisasi ikon Lucide
            lucide.createIcons();
        }

        /**
         * Merender daftar berita di halaman Berita atau Beranda.
         * @param {Array<Object>} newsData Data berita.
         * @param {number} maxItems Jumlah maksimum item (untuk Beranda).
         * @returns {string} HTML daftar berita.
         */
        function renderNewsList(newsData, maxItems = Infinity) {
            if (newsData.length === 0) return '<p class="text-gray-500 text-center p-4">Tidak ada berita yang tersedia.</p>';

            const limitedNews = newsData.slice(0, maxItems);
            const placeholderUrl = 'https://placehold.co/400x200/cccccc/333333?text=Gambar+Tidak+Tersedia';

            return `
                <div class="space-y-4">
                    ${limitedNews.map(news => {
                        // MENGGUNAKAN IMAGE PROXY AGAR GAMBAR PASTI MUNCUL
                        const imageUrl = getProxyImageUrl(news.URL_Gambar);
                        return `
                        <div onclick="navigateToDetail('${NEWS_DETAIL_PAGE}', ${news.id})" class="bg-white p-4 rounded-xl shadow-md transition-shadow hover:shadow-lg cursor-pointer border border-gray-100">
                            <img src="${imageUrl}"
                                 alt="${news.Judul_Berita}"
                                 class="w-full h-40 object-cover rounded-lg mb-3"
                                 onerror="this.onerror=null;this.src='${placeholderUrl}';" />
                            <h2 class="text-lg font-semibold text-gray-800 mb-1 leading-snug">${news.Judul_Berita}</h2>
                            <p class="text-xs text-gray-500 mb-2">
                                <i data-lucide="Calendar" class="icon-sm inline-block mr-1"></i> ${news.Tanggal}
                                <span class="mx-2 text-gray-300">|</span>
                                <i data-lucide="User" class="icon-sm inline-block mr-1"></i> ${news.Penulis}
                            </p>
                            <p class="text-sm text-gray-600 line-clamp-2">${news.Isi_Berita.substring(0, 100)}...</p>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
        }

        /**
         * Merender detail berita.
         * @param {Object} news Detail berita.
         * @returns {string} HTML detail berita.
         */
        function renderNewsDetail(news) {
            const placeholderUrl = 'https://placehold.co/800x400/cccccc/333333?text=Gambar+Tidak+Tersedia';
            // MENGGUNAKAN IMAGE PROXY AGAR GAMBAR PASTI MUNCUL
            const imageUrl = getProxyImageUrl(news.URL_Gambar);

            return `
                <div class="space-y-4">
                    <button onclick="navigate('Berita')" class="text-blue-600 hover:text-blue-800 flex items-center mb-4">
                        <i data-lucide="ArrowLeft" class="icon-sm mr-1"></i> Kembali ke Berita
                    </button>
                    <img src="${imageUrl}"
                         alt="${news.Judul_Berita}"
                         class="w-full h-64 object-cover rounded-xl shadow-lg mb-4"
                         onerror="this.onerror=null;this.src='${placeholderUrl}';" />

                    <h1 class="text-2xl font-extrabold text-gray-900">${news.Judul_Berita}</h1>

                    <div class="text-sm text-gray-500 flex items-center space-x-4 border-b pb-3 mb-4">
                        <span class="flex items-center"><i data-lucide="Calendar" class="icon-sm mr-1"></i> ${news.Tanggal}</span>
                        <span class="flex items-center"><i data-lucide="User" class="icon-sm mr-1"></i> ${news.Penulis}</span>
                    </div>

                    <div class="prose max-w-none text-gray-700 leading-relaxed">
                        ${news.Isi_Berita.replace(/\n/g, '<br><br>')}
                    </div>
                </div>
            `;
        }

        /**
         * Merender daftar kompetisi.
         * @param {Array<Object>} competitionData Data kompetisi.
         * @returns {string} HTML daftar kompetisi.
         */
        function renderCompetitionList(competitionData) {
            if (competitionData.length === 0) return '<p class="text-gray-500 text-center p-4">Tidak ada data kompetisi yang tersedia.</p>';

            return `
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Daftar Kompetisi</h1>
                <div class="space-y-4">
                    ${competitionData.map(comp => `
                        <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                            <div class="flex items-start space-x-4">
                                <div class="p-3 bg-blue-100 rounded-lg text-blue-600 flex-shrink-0">
                                    <i data-lucide="Trophy" class="icon-md"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-800 mb-1">${comp.Nama_Kompetisi}</h2>
                                    <p class="text-sm text-gray-600 mb-2">${comp.Kategori}</p>
                                </div>
                            </div>
                            <div class="mt-3 text-sm space-y-1">
                                <p class="flex items-center text-gray-700">
                                    <i data-lucide="CalendarCheck" class="icon-sm mr-2 text-green-500"></i>
                                    <strong>Periode:</strong> ${comp.Tahun}
                                </p>
                                <p class="flex items-center text-gray-700">
                                    <i data-lucide="MapPin" class="icon-sm mr-2 text-red-500"></i>
                                    <strong>Lokasi:</strong> ${comp.Lokasi}
                                </p>
                                <p class="text-sm text-gray-700 mt-2">
                                    <strong>Klub Peserta:</strong> ${comp.Klub_Peserta || 'N/A'}
                                </p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /**
         * Merender daftar klub.
         * @param {Array<Object>} clubData Data klub.
         * @returns {string} HTML daftar klub.
         */
        function renderClubList(clubData) {
            if (clubData.length === 0) return '<p class="text-gray-500 text-center p-4">Tidak ada data klub yang tersedia.</p>';

            return `
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Daftar Klub Anggota</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${clubData.map(club => `
                        <div onclick="navigateToDetail('${CLUB_DETAIL_PAGE}', '${club.Nama_Klub}')"
                             class="bg-white p-4 rounded-xl shadow-md transition-all hover:shadow-lg cursor-pointer border border-gray-100 flex items-center space-x-3">
                            <div class="p-2 bg-gray-100 rounded-full text-blue-600 flex-shrink-0">
                                <i data-lucide="Shield" class="icon-md"></i>
                            </div>
                            <div>
                                <h2 class="text-lg font-semibold text-gray-800">${club.Nama_Klub}</h2>
                                <p class="text-sm text-gray-500">${club.Tahun_Berdiri}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /**
         * Merender detail klub (dengan data kompetisi yang diikuti).
         * @param {string} clubName Nama klub.
         * @returns {string} HTML detail klub.
         */
        async function renderClubDetail(clubName) {
            const club = appData.clubs.find(c => c.Nama_Klub === clubName);
            const competitionsData = await fetchData('getCompetitionsByClub', { clubName: clubName });
            const competitions = competitionsData || [];

            const clubDataHtml = club ? `
                <div class="bg-blue-600 text-white p-6 rounded-xl shadow-lg mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="p-3 bg-white rounded-full text-blue-600">
                            <i data-lucide="Shield" class="icon-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">${club.Nama_Klub}</h1>
                            <p class="text-sm">Berdiri: ${club.Tahun_Berdiri}</p>
                        </div>
                    </div>
                    <p class="mt-4 text-sm">${club.Deskripsi_Klub || 'Tidak ada deskripsi tersedia.'}</p>
                </div>
            ` : `<p class="text-red-500">Data klub tidak ditemukan.</p>`;

            const competitionListHtml = competitions.length > 0 ? `
                <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Partisipasi Kompetisi</h2>
                <div class="space-y-3">
                    ${competitions.map(comp => `
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="font-semibold text-gray-800">${comp.Nama_Kompetisi} (${comp.Tahun})</h3>
                            <p class="text-sm text-gray-600">Kategori: ${comp.Kategori}</p>
                            <p class="text-xs text-gray-500">Lokasi: ${comp.Lokasi}</p>
                        </div>
                    `).join('')}
                </div>
            ` : `<p class="text-gray-500 text-center p-4 border rounded-lg">Klub ini belum terdaftar di kompetisi manapun.</p>`;

            return `
                <button onclick="navigate('Klub')" class="text-blue-600 hover:text-blue-800 flex items-center mb-4">
                    <i data-lucide="ArrowLeft" class="icon-sm mr-1"></i> Kembali ke Daftar Klub
                </button>
                ${clubDataHtml}
                ${competitionListHtml}
            `;
        }


        // --- FUNGSI RENDER HALAMAN ---

        /**
         * Merender Halaman Beranda.
         * @returns {string} HTML Halaman Beranda.
         */
        function renderHomePage() {
            // Mengambil 3 berita terbaru untuk beranda
            const latestNews = appData.news.slice(0, 3);
            const newsHtml = renderNewsList(latestNews, 3);

            return `
                <div class="space-y-6">
                    <!-- Carousel Placeholder -->
                    <div class="bg-gray-200 h-48 rounded-xl shadow-md flex items-center justify-center text-gray-600">
                        <i data-lucide="Image" class="icon-lg mr-2"></i> Banner / Gambar Utama
                    </div>

                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Berita Terbaru</h2>
                    ${newsHtml}

                    <div class="text-center pt-2">
                        <button onclick="navigate('Berita')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-full transition-colors flex items-center mx-auto">
                             Lihat Semua Berita <i data-lucide="ArrowRight" class="icon-sm ml-2"></i>
                        </button>
                    </div>

                     <!-- Statistik Singkat (Contoh) -->
                    <div class="grid grid-cols-3 gap-4 text-center border-t pt-4">
                        <div class="p-2 bg-blue-50 rounded-lg">
                            <i data-lucide="Shield" class="icon-md text-blue-600 mx-auto block mb-1"></i>
                            <div class="text-xl font-bold text-gray-800">${appData.clubs.length}</div>
                            <div class="text-xs text-gray-600">Klub</div>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg">
                            <i data-lucide="Trophy" class="icon-md text-green-600 mx-auto block mb-1"></i>
                            <div class="text-xl font-bold text-gray-800">${appData.competitions.length}</div>
                            <div class="text-xs text-gray-600">Kompetisi</div>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded-lg">
                            <i data-lucide="Newspaper" class="icon-md text-yellow-600 mx-auto block mb-1"></i>
                            <div class="text-xl font-bold text-gray-800">${appData.news.length}</div>
                            <div class="text-xs text-gray-600">Berita</div>
                        </div>
                    </div>
                </div>
            `;
        }


        /**
         * Fungsi utama untuk merender halaman saat ini.
         */
        async function renderPage() {
            if (!isDataLoaded) return; // Jangan render jika data belum dimuat

            const contentDiv = document.getElementById('page-content');
            let contentHtml = '';

            // Sembunyikan loading state
            const loadingState = document.getElementById('loading-state');
            if (loadingState) loadingState.classList.add('hidden');

            // Render berdasarkan halaman saat ini
            if (currentPage === 'Beranda') {
                contentHtml = renderHomePage();
            } else if (currentPage === 'Berita') {
                contentHtml = `
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">Semua Berita</h1>
                    ${renderNewsList(appData.news)}
                `;
            } else if (currentPage === 'Kompetisi') {
                contentHtml = renderCompetitionList(appData.competitions);
            } else if (currentPage === 'Klub') {
                contentHtml = renderClubList(appData.clubs);
            } else if (currentPage === NEWS_DETAIL_PAGE && detailItemId !== null) {
                // Halaman Detail Berita
                const detailData = appData.news.find(n => n.id === detailItemId);
                if (detailData) {
                    contentHtml = renderNewsDetail(detailData);
                } else {
                    contentHtml = `<div class="text-red-500 text-center p-8">Berita dengan ID ${detailItemId} tidak ditemukan.</div>`;
                }
            } else if (currentPage === CLUB_DETAIL_PAGE && detailItemId !== null) {
                // Halaman Detail Klub. detailItemId di sini adalah Nama_Klub (string)
                contentHtml = await renderClubDetail(detailItemId);
            } else {
                // Halaman tidak dikenal, kembali ke Beranda
                currentPage = 'Beranda';
                contentHtml = renderHomePage();
            }

            contentDiv.innerHTML = contentHtml;
            // Menginisialisasi ulang ikon Lucide untuk konten yang baru dirender
            lucide.createIcons();
            window.scrollTo(0, 0); // Gulir ke atas setiap kali halaman berubah
        }


        // --- INISIALISASI ---

        async function initializeApp() {
            // Tentukan halaman awal dari hash URL
            currentPage = getPageFromHash(window.location.hash);

            // Fetch data awal
            document.getElementById('loading-state').classList.remove('hidden');
            let data = await fetchData('getInitialData');

            if (data) {
                appData = data;
                isDataLoaded = true;

                // Render ulang dengan data yang dimuat
                currentPage = getPageFromHash(window.location.hash);
                // Logika untuk memastikan detailItemId diatur ulang saat reload di halaman detail
                if ((currentPage === NEWS_DETAIL_PAGE || currentPage === CLUB_DETAIL_PAGE) && detailItemId === null) {
                     currentPage = getPageFromHash(window.location.hash);
                } else if (currentPage === NEWS_DETAIL_PAGE && detailItemId !== null) {
                    // Cek apakah berita ada di data
                    const detail = appData.news.find(n => n.id === detailItemId);
                    if (!detail) {
                        alertMessage(`Detail Berita ID ${detailItemId} tidak ditemukan, kembali ke Berita.`, 'error');
                        currentPage = 'Berita';
                        detailItemId = null;
                    }
                }

                renderPage();
                renderNavBar();

                // Pastikan hash di URL sesuai dengan halaman yang dimuat, tapi jangan push history baru
                let expectedHash = `#${currentPage.toLowerCase()}`;
                if (currentPage === NEWS_DETAIL_PAGE && detailItemId !== null) {
                    expectedHash = `#${currentPage.toLowerCase()}-${detailItemId}`;
                } else if (currentPage === CLUB_DETAIL_PAGE && detailItemId !== null) {
                    expectedHash = `#${currentPage.toLowerCase()}-${detailItemId.toLowerCase().replace(/\s/g, '_')}`;
                } else {
                    detailItemId = null; // Pastikan detailId null untuk halaman utama
                }

                if (window.location.hash !== expectedHash) {
                    // Gunakan replaceState agar tombol back tetap berfungsi dengan baik
                    window.history.replaceState({ page: currentPage }, currentPage, expectedHash);
                }
            } else {
                // Biarkan pesan error di fetchData tetap terlihat jika gagal
            }

        };

        // --- History API Listener (Mengatasi tombol back) ---
        window.addEventListener('popstate', (event) => {
            if (!isDataLoaded) return;

            // Navigasi ke halaman yang tersimpan di state atau berdasarkan hash
            // getPageFromHash sudah mengatur currentPage dan detailItemId
            const page = event.state && event.state.page ? event.state.page : getPageFromHash(window.location.hash);
            
            if (page !== currentPage) {
                 navigate(page, true); // True to skip pushing a new state
            }
        });

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
